<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    th:replace="~{layout(titulo=${reconciliacao.id == null ? 'Nova Reconciliação' : 'Editar Reconciliação'}, content=~{::content}, pageScripts=~{::pageScripts})}">

<head>
    <title th:text="${reconciliacao.id == null ? 'Nova Reconciliação' : 'Editar Reconciliação'}"></title>
</head>

<body>
    <div th:fragment="content">
        <div class="page-header">
            <div class="add-item d-flex">
                <div class="page-title">
                    <h4 th:text="${reconciliacao.id == null ? 'Nova Reconciliação' : 'Editar Reconciliação'}">
                        Nova Reconciliação
                    </h4>
                    <h6>Preencha as informações da reconciliação mensal</h6>
                </div>
            </div>
            <ul class="table-top-head">
                <li>
                    <div class="page-btn">
                        <a th:href="@{/reconciliacao}" class="btn btn-secondary">
                            <i data-feather="arrow-left" class="me-2"></i>Voltar para a Lista
                        </a>
                    </div>
                </li>
            </ul>
        </div>

        <form id="reconciliacaoForm" th:action="@{/reconciliacao/salvar}" th:object="${reconciliacao}" method="post">
            <input type="hidden" th:field="*{id}" />
            <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-body">
                            <!-- DADOS DA RECONCILIAÇÃO -->
                            <div class="card-title-head">
                                <h6>
                                    <span><i data-feather="calendar" class="feather-edit"></i></span>
                                    Dados da Reconciliação
                                </h6>
                            </div>
                            <div class="row">
                                <div class="col-lg-4 col-md-6">
                                    <div class="form-group mb-3">
                                        <label>Mês</label>
                                        <select class="form-select" th:field="*{mes}" required>
                                            <option value="">Selecione...</option>
                                            <option th:each="mesEntry : ${meses}" th:value="${mesEntry.key}"
                                                th:text="${mesEntry.value}"
                                                th:selected="${reconciliacao.mes != null and mesEntry.key == reconciliacao.mes}">
                                            </option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-6">
                                    <div class="form-group mb-3">
                                        <label>Ano</label>
                                        <select class="form-select" th:field="*{ano}" required>
                                            <option value="">Selecione...</option>
                                            <option th:each="year : ${years}" th:value="${year}" th:text="${year}"
                                                th:selected="${reconciliacao.ano != null and year == reconciliacao.ano}">
                                            </option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-6">
                                    <div class="form-group mb-3">
                                        <label>Saldo Inicial</label>
                                        <input type="text" id="saldoInicialInput" class="form-control money"
                                            th:value="${reconciliacao.saldoInicial != null ? #numbers.formatDecimal(reconciliacao.saldoInicial, 1, 'DEFAULT', 2, 'DEFAULT') : '0,00'}" />
                                        <input type="hidden" id="saldoInicialPadrao"
                                            th:field="*{saldoInicial}" />
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-6">
                                    <div class="form-group mb-3">
                                        <label>Total de Entradas</label>
                                        <input type="text" id="totalEntradasInput" class="form-control money"
                                            th:value="${reconciliacao.totalEntradas != null ? #numbers.formatDecimal(reconciliacao.totalEntradas, 1, 'DEFAULT', 2, 'DEFAULT') : '0,00'}" />
                                        <input type="hidden" id="totalEntradasPadrao"
                                            th:field="*{totalEntradas}" />
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-6">
                                    <div class="form-group mb-3">
                                        <label>Total de Saídas</label>
                                        <input type="text" id="totalSaidasInput" class="form-control money"
                                            th:value="${reconciliacao.totalSaidas != null ? #numbers.formatDecimal(reconciliacao.totalSaidas, 1, 'DEFAULT', 2, 'DEFAULT') : '0,00'}" />
                                        <input type="hidden" id="totalSaidasPadrao"
                                            th:field="*{totalSaidas}" />
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-6">
                                    <div class="form-group mb-3">
                                        <label>Saldo Final</label>
                                        <input type="text" id="saldoFinalInput" class="form-control money" readonly
                                            th:value="${reconciliacao.saldoFinal != null ? #numbers.formatDecimal(reconciliacao.saldoFinal, 1, 'DEFAULT', 2, 'DEFAULT') : '0,00'}" />
                                        <input type="hidden" id="saldoFinalPadrao"
                                            th:field="*{saldoFinal}" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-end mb-3">
                <a th:href="@{/reconciliacao}" class="btn btn-cancel me-2">Cancelar</a>
                <button type="submit" id="submitReconciliacaoBtn" class="btn btn-submit">
                    Salvar Reconciliação
                </button>
            </div>
        </form>
    </div>

    <th:block th:fragment="pageScripts">
        <script>
            $(document).ready(function () {
                $('.money').maskMoney({
                    prefix: 'R$ ',
                    thousands: '.',
                    decimal: ',',
                    allowZero: true
                });

                $('#submitReconciliacaoBtn').on('click', function (e) {
                    e.preventDefault();

                    // Validar campos obrigatórios
                    var mes = $('select[name="mes"]').val();
                    var ano = $('select[name="ano"]').val();

                    if (!mes) {
                        showToast('O campo mês é obrigatório.', 'error');
                        return;
                    }

                    if (!ano) {
                        showToast('O campo ano é obrigatório.', 'error');
                        return;
                    }

                    $('.money').each(function () {
                        var unmaskedValue = $(this).maskMoney('unmasked')[0];
                        $(this).val(unmaskedValue);
                    });

                    $('#reconciliacaoForm').submit();
                });

                // Atualizar o valor do campo oculto do saldo inicial
                $('#saldoInicialInput').on('blur', function () {
                    var unmaskedValue = $(this).maskMoney('unmasked')[0];
                    $('#saldoInicialPadrao').val(unmaskedValue);
                });
                
                // Atualizar o valor do campo oculto do total de entradas
                $('#totalEntradasInput').on('blur', function () {
                    var unmaskedValue = $(this).maskMoney('unmasked')[0];
                    $('#totalEntradasPadrao').val(unmaskedValue);
                });
                
                // Atualizar o valor do campo oculto do total de saídas
                $('#totalSaidasInput').on('blur', function () {
                    var unmaskedValue = $(this).maskMoney('unmasked')[0];
                    $('#totalSaidasPadrao').val(unmaskedValue);
                });

                // Função para mostrar toasts
                function showToast(message, type) {
                    var toastContainer = $('.toast-container');
                    if (toastContainer.length === 0) {
                        toastContainer = $('<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1080;"></div>');
                        $('body').append(toastContainer);
                    }

                    var toastClass = type === 'error' ? 'text-bg-danger' :
                        type === 'success' ? 'text-bg-success' : 'text-bg-warning';

                    var toast = $(`
                        <div class="toast align-items-center border-0 show ${toastClass}" role="alert">
                            <div class="d-flex">
                                <div class="toast-body">
                                    ${message}
                                </div>
                                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                            </div>
                        </div>
                    `);

                    toastContainer.append(toast);

                    setTimeout(function () {
                        toast.removeClass('show');
                        setTimeout(function () {
                            toast.remove();
                        }, 300);
                    }, 5000);
                }
            });
        </script>
    </th:block>
</body>

</html>