<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    th:replace="~{layout(titulo=${reconciliacao.id == null ? 'Nova Reconciliação' : 'Editar Reconciliação'}, content=~{::content}, pageScripts=~{::pageScripts})}">

<head>
    <title th:text="${reconciliacao.id == null ? 'Nova Reconciliação' : 'Editar Reconciliação'}"></title>
</head>

<body>
    <div th:fragment="content">
        <div class="page-header">
            <div class="add-item d-flex">
                <div class="page-title">
                    <h4 th:text="${reconciliacao.id == null ? 'Nova Reconciliação' : 'Editar Reconciliação'}">
                        Nova Reconciliação
                    </h4>
                    <h6>Preencha as informações da reconciliação mensal</h6>
                </div>
            </div>
            <ul class="table-top-head">
                <li>
                    <div class="page-btn">
                        <a th:href="@{/reconciliacao}" class="btn btn-secondary">
                            <i data-feather="arrow-left" class="me-2"></i>Voltar para a Lista
                        </a>
                    </div>
                </li>
            </ul>
        </div>

        <form id="reconciliacaoForm" th:action="@{/reconciliacao/salvar}" th:object="${reconciliacao}" method="post">
            <input type="hidden" th:field="*{id}" />
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

            <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-body">
                            <!-- DADOS DA RECONCILIAÇÃO -->
                            <div class="card-title-head">
                                <h6>
                                    <span><i data-feather="calendar" class="feather-edit"></i></span>
                                    Dados da Reconciliação
                                </h6>
                            </div>
                            <div class="row">
                                <div class="col-lg-4 col-md-6">
                                    <div class="form-group mb-3">
                                        <label>Mês</label>
                                        <select class="form-select" th:field="*{mes}" required>
                                            <option value="">Selecione...</option>
                                            <option th:each="mesEntry : ${meses}" th:value="${mesEntry.key}"
                                                th:text="${mesEntry.value}"
                                                th:selected="${reconciliacao.mes != null and mesEntry.key == reconciliacao.mes}">
                                            </option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-6">
                                    <div class="form-group mb-3">
                                        <label>Ano</label>
                                        <select class="form-select" th:field="*{ano}" required>
                                            <option value="">Selecione...</option>
                                            <option th:each="year : ${years}" th:value="${year}" th:text="${year}"
                                                th:selected="${reconciliacao.ano != null and year == reconciliacao.ano}">
                                            </option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-6">
                                    <div class="form-group mb-3">
                                        <label>Saldo Inicial</label>
                                        <input type="text" class="form-control money" th:field="*{saldoInicial}" />
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-6">
                                    <div class="form-group mb-3">
                                        <label>Total de Entradas</label>
                                        <input type="text" class="form-control money" th:field="*{totalEntradas}" />
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-6">
                                    <div class="form-group mb-3">
                                        <label>Total de Saídas</label>
                                        <input type="text" class="form-control money" th:field="*{totalSaidas}" />
                                    </div>
                                </div>
                                <div class="col-lg-4 col-md-6">
                                    <div class="form-group mb-3">
                                        <label>Saldo Final</label>
                                        <input type="text" class="form-control money" th:field="*{saldoFinal}" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-end mb-3">
                <a th:href="@{/reconciliacao}" class="btn btn-cancel me-2">Cancelar</a>
                <button type="submit" id="submitReconciliacaoBtn" class="btn btn-submit">
                    Salvar Reconciliação
                </button>
            </div>
        </form>
    </div>

    <th:block th:fragment="pageScripts">
        <script>
            $(document).ready(function () {
                console.log('Reconciliação form script loaded');

                // Inicializar máscaras de dinheiro
                $('.money').maskMoney({
                    prefix: 'R$ ',
                    thousands: '.',
                    decimal: ',',
                    allowZero: true
                });

                // Função para mostrar toasts
                function showToast(message, type) {
                    var toastContainer = $('.toast-container');
                    if (toastContainer.length === 0) {
                        toastContainer = $('<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1080;"></div>');
                        $('body').append(toastContainer);
                    }

                    var toastClass = type === 'error' ? 'text-bg-danger' :
                        type === 'success' ? 'text-bg-success' : 'text-bg-warning';

                    var toast = $(`
                        <div class="toast align-items-center border-0 show ${toastClass}" role="alert">
                            <div class="d-flex">
                                <div class="toast-body">
                                    ${message}
                                </div>
                                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                            </div>
                        </div>
                    `);

                    toastContainer.append(toast);

                    setTimeout(function () {
                        toast.removeClass('show');
                        setTimeout(function () {
                            toast.remove();
                        }, 300);
                    }, 5000);
                }

                // Handler para o formulário
                $('#reconciliacaoForm').on('submit', function (e) {
                    console.log('Form submit triggered');

                    // Validar campos obrigatórios
                    var mes = $('select[name="mes"]').val();
                    var ano = $('select[name="ano"]').val();

                    if (!mes || mes === '') {
                        e.preventDefault();
                        showToast('O campo mês é obrigatório.', 'error');
                        return false;
                    }

                    if (!ano || ano === '') {
                        e.preventDefault();
                        showToast('O campo ano é obrigatório.', 'error');
                        return false;
                    }

                    // Converter valores monetários para formato que o Spring entende
                    $('.money').each(function () {
                        var $this = $(this);
                        var currentValue = $this.val();

                        if (currentValue && currentValue.trim() !== '') {
                            // Remover formatação e converter para formato decimal padrão
                            var cleanedValue = currentValue
                                .replace('R$ ', '')
                                .replace(/\./g, '')
                                .replace(',', '.');

                            $this.val(cleanedValue);
                        }
                    });

                    console.log('Form validation passed, submitting...');
                    return true;
                });
            });
        </script>
    </th:block>
</body>

</html>