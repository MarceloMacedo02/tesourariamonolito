<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org"
  th:replace="~{layout(titulo='Upload de Arquivo OFX', content=~{::content}, pageScripts=~{::pageScripts})}">

<body>
  <div th:fragment="content">
    <div class="page-header">
      <div class="add-item d-flex">
        <div class="page-title">
          <h4>Upload de Arquivo OFX</h4>
          <h6>Envie seu arquivo OFX para processamento</h6>
        </div>
      </div>
    </div>

    <div class="alert alert-info">
      <h5>Importante sobre a importação de transações</h5>
      <p>Durante o processamento das transações de crédito, o sistema irá:</p>
      <ul>
        <li>Primeiro tentar localizar o sócio pelo CPF</li>
        <li>Se não encontrar pelo CPF, tentará localizar pelo nome (parcial)</li>
        <li>Se não encontrar o sócio, irá criar automaticamente um novo registro</li>
        <li class="mt-2"><strong>Atenção:</strong> Verifique sempre os dados dos sócios criados automaticamente na lista de sócios</li>
      </ul>
    </div>

    <div class="card">
      <div class="card-body">
        <form th:action="@{/transacoes/upload}" method="post" enctype="multipart/form-data">
          <div class="mb-3">
            <label for="file" class="form-label">Selecione o arquivo OFX:</label>
            <input class="form-control" type="file" id="file" name="file" accept=".ofx" required>
          </div>
          <button type="submit" class="btn btn-primary">Upload</button>
        </form>
      </div>
    </div>

    <div th:if="${success}" class="alert alert-success mt-3" role="alert">
      <span th:text="${success}"></span>
    </div>
    <div th:if="${error}" class="alert alert-danger mt-3" role="alert">
      <span th:text="${error}"></span>
    </div>
  </div>
</body>

<th:block th:fragment="pageScripts">
  <script th:inline="javascript">
    /*<![CDATA[*/
    var availableMonthsData = /*[[${availableMonths}]]*/ {};
    var initialCurrentMonth = /*[[${currentMonth}]]*/ null;
    var initialCurrentYear = /*[[${currentYear}]]*/ null;
    /*]]>*/

    $(document).ready(function () {
      if ($("#transacoesTable").length > 0) {
        $("#transacoesTable").DataTable({
          destroy: true, // Evita o erro de reinicialização
          pageLength: 20,
          columns: [
            { data: 'data' },
            { data: 'tipo.descricao' },
            { data: 'valor' },
            { data: 'fornecedorOuSocio' },
            { data: 'documento' },
            { data: 'descricao' },
            { data: 'lancado.descricao' }
          ]
        });
      }

      $('#year').change(function () {
        var selectedYear = $(this).val();
        var monthSelect = $('#month');
        var previouslySelectedMonth = monthSelect.val(); // Store the currently selected month

        monthSelect.empty();
        monthSelect.append('<option value="">Todos</option>');

        if (selectedYear && availableMonthsData[selectedYear]) {
          var monthsForYear = availableMonthsData[selectedYear];
          $.each(monthsForYear, function (index, monthNum) {
            var monthName = new Date(2000, monthNum - 1, 1).toLocaleString('pt-br', { month: 'long' });
            var option = $('<option></option>').val(monthNum).text(monthName);
            monthSelect.append(option);
          });
        }

        // Attempt to re-select the previously selected month, or the initial current month
        if (previouslySelectedMonth && monthSelect.find('option[value="' + previouslySelectedMonth + '"]').length > 0) {
          monthSelect.val(previouslySelectedMonth);
        } else if (initialCurrentMonth && selectedYear == initialCurrentYear && monthSelect.find('option[value="' + initialCurrentMonth + '"]').length > 0) {
          monthSelect.val(initialCurrentMonth);
        } else {
          monthSelect.val(""); // Select 'Todos' if no valid month can be pre-selected
        }

      }).trigger('change'); // Trigger change on load to populate months for initial year
    });
  </script>
</th:block>
</html>
