<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout(titulo='Registrar Recebimento de Crédito', content=~{::content}, pageScripts=~{::pageScripts})}">
<head>
    <title>Registrar Recebimento de Crédito</title>
</head>
<body>
<div th:fragment="content">
    <input type="hidden" id="currentSocioId" th:value="${transacao.socio != null ? transacao.socio.id : ''}" />
    <input type="hidden" id="currentSocioNome" th:value="${transacao.socio != null ? transacao.socio.nome : ''}" />
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">Registrar Recebimento de Crédito</h1>
        <div>
            <a th:if="${fromTitular != null}" th:href="@{/cobrancas/pagar/{id}(id=${fromTitular})}" class="btn btn-info">Voltar ao Sócio Titular</a>
            <a th:href="@{/cobrancas}" class="btn btn-secondary">Voltar para a Lista</a>
        </div>
    </div>
    <div th:if="${warning}" class="alert alert-warning" role="alert" th:text="${warning}"></div>

    <div class="card mb-4">
        <div class="card-header">
            Detalhes da Transação de Crédito
        </div>
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-3">ID</dt>
                <dd class="col-sm-9" th:text="${transacao.id}"></dd>

                <dt class="col-sm-3">Pagador</dt>
                <dd class="col-sm-9" th:text="${transacao.socio != null ? transacao.socio.nome : transacao.fornecedorOuSocio}"></dd>

                                <dt class="col-sm-3">Valor</dt>
                <dd class="col-sm-9" th:text="${'R$ ' + #numbers.formatDecimal(transacao.valor, 0, 'POINT', 2, 'POINT')}"></dd>

                <dt class="col-sm-3">Descrição</dt>
                <dd class="col-sm-9" th:text="${transacao.descricao}"></dd>

                <dt class="col-sm-3">Data</dt>
                <dd class="col-sm-9" th:text="${#temporals.format(transacao.data, 'dd/MM/yyyy')}"></dd>
            </dl>
        </div>
    </div>

    <!-- Nova Seção: Contas a Receber -->
    <div class="card mt-4">
        <div class="card-header">
            Contas a Receber do Sócio
            <span class="float-end">Total Selecionado: <span id="total-contas-receber-selecionado">R$ 0,00</span></span>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th></th> <!-- Checkbox column -->
                            <th>Descrição</th>
                            <th>Vencimento</th>
                            <th>Valor</th>
                            <th>Tipo</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Contas a receber serão carregadas aqui via Thymeleaf/JavaScript -->
                        <tr th:each="contaReceber : ${contasAReceber}">
                            <td>
                                <input type="checkbox" class="conta-receber-checkbox" th:data-valor="${contaReceber.valor}" />
                            </td>
                            <td th:text="${contaReceber.descricao}"></td>
                            <td th:text="${#temporals.format(contaReceber.dataVencimento, 'dd/MM/yyyy')}"></td>
                            <td th:text="${'R$ ' + #numbers.formatDecimal(contaReceber.valor, 0, 'POINT', 2, 'POINT')}"></td>
                            <td th:text="${contaReceber.tipoCobranca}"></td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(contasAReceber)}">
                            <td colspan="4" class="text-center">Nenhuma conta a receber encontrada para o sócio.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="text-end mt-3">
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#novaContaReceberModal">
                    Adicionar Nova Conta a Receber
                </button>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#novaPreCobrancaModal">
                    Adicionar Pré-Cobrança
                </button>
            </div>
        </div>
    </div>

    <!-- Seção de Pré-Cobranças -->
    <div class="card mt-4">
        <div class="card-header">
            Pré-Cobranças
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped" id="preCobrancasList">
                    <thead>
                        <tr>
                            <th></th> <!-- Checkbox column -->
                            <th>Descrição</th>
                            <th>Vencimento</th>
                            <th>Valor</th>
                            <th>Tipo</th>
                            <th>Sócio</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Pré-cobranças serão adicionadas aqui via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Seção de Todas as Cobranças em Aberto do Sócio e Dependentes -->
    <div class="card mt-4" th:if="${allOpenCobrancas != null and not #lists.isEmpty(allOpenCobrancas)}">
        <div class="card-header">
            Todas as Cobranças em Aberto do Sócio e Dependentes
            <span class="float-end">Total Selecionado: <span id="total-selecionado">R$ 0,00</span></span>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th></th> <!-- New Checkbox column header -->
                            <th>Sócio/Dependente</th>
                            <th>Descrição</th>
                            <th>Vencimento</th>
                            <th>Valor</th>
                            <th>Tipo</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="cobrancaDep : ${allOpenCobrancas}">
                            <td>
                                <input type="checkbox" class="cobranca-checkbox" th:data-valor="${cobrancaDep.valor}" />
                            </td>
                            <td th:text="${cobrancaDep.socio != null ? cobrancaDep.socio.nome : 'N/A'}"></td>
                            <td th:text="${cobrancaDep.descricao}"></td>
                            <td th:text="${#temporals.format(cobrancaDep.dataVencimento, 'dd/MM/yyyy')}"></td>
                            <td th:text="${'R$ ' + #numbers.formatDecimal(cobrancaDep.valor, 0, 'POINT', 2, 'POINT')}"></td>
                            <td th:text="${cobrancaDep.tipoCobranca}"></td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(allOpenCobrancas)}">
                            <td colspan="5" class="text-center">Nenhuma cobrança em aberto para o sócio ou seus dependentes.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div th:if="${allOpenCobrancas == null or #lists.isEmpty(allOpenCobrancas)}" class="alert alert-info mt-3">
        Nenhuma cobrança em aberto encontrada para o sócio ou seus dependentes.
    </div>

    <!-- Modal para Adicionar Nova Conta a Receber -->
    <div class="modal fade" id="novaContaReceberModal" tabindex="-1" aria-labelledby="novaContaReceberModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="novaContaReceberModalLabel">Adicionar Nova Conta a Receber</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="novaContaReceberForm">
                        <div class="mb-3">
                            <label for="modalRubricaSelect" class="form-label">Rubrica</label>
                            <select class="form-control" id="modalRubricaSelect" required name="rubricaId">
                                <option value="">Selecione a rubrica</option>
                                <option th:each="rubrica : ${rubricas}"
                                        th:value="${rubrica.id}"
                                        th:text="${rubrica.nome}"></option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="modalDescricaoInput" class="form-label">Descrição</label>
                            <input type="text" class="form-control" id="modalDescricaoInput" required name="descricao" />
                        </div>
                        <div class="mb-3">
                            <label for="modalDataVencimentoInput" class="form-label">Data de Vencimento</label>
                            <input type="text" class="form-control" id="modalDataVencimentoInput" required name="dataVencimento" />
                        </div>
                        <div class="mb-3">
                            <label for="modalValorInput" class="form-label">Valor</label>
                            <input type="text" class="form-control" id="modalValorInput" required />
                            <input type="hidden" id="modalValorInputHidden" name="valor" />
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="salvarNovaContaReceber">Salvar Conta</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar Nova Pré-Cobrança -->
    <div class="modal fade" id="novaPreCobrancaModal" tabindex="-1" aria-labelledby="novaPreCobrancaModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="novaPreCobrancaModalLabel">Adicionar Nova Pré-Cobrança</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="novaPreCobrancaForm">
                        <div class="mb-3">
                            <label for="modalPreCobrancaValorInput" class="form-label">Valor</label>
                            <input type="text" class="form-control" id="modalPreCobrancaValorInput" required />
                            <input type="hidden" id="modalPreCobrancaValorInputHidden" name="valor" />
                        </div>
                        <div class="mb-3">
                            <label for="modalPreCobrancaDescricaoInput" class="form-label">Descrição</label>
                            <input type="text" class="form-control" id="modalPreCobrancaDescricaoInput" required name="descricao" />
                        </div>
                        <div class="mb-3">
                            <label for="modalPreCobrancaDataVencimentoInput" class="form-label">Data de Vencimento</label>
                            <input type="text" class="form-control" id="modalPreCobrancaDataVencimentoInput" required name="dataVencimento" />
                        </div>
                        <div class="mb-3">
                            <label for="modalPreCobrancaRubricaSelect" class="form-label">Rubrica</label>
                            <select class="form-control" id="modalPreCobrancaRubricaSelect" required name="rubricaId">
                                <option value="">Selecione a rubrica</option>
                                <option th:each="rubrica : ${rubricas}"
                                        th:value="${rubrica.id}"
                                        th:text="${rubrica.nome}"></option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="modalPreCobrancaTipoCobrancaSelect" class="form-label">Tipo de Cobrança</label>
                            <select class="form-control" id="modalPreCobrancaTipoCobrancaSelect" required name="tipoCobranca">
                                <option value="">Selecione o tipo</option>
                                <option value="MENSALIDADE">Mensalidade</option>
                                <option value="OUTRAS_RUBRICAS">Outras Rubricas</option>
                                <option value="AVULSA">Avulsa</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="modalPreCobrancaSocioSelect" class="form-label">Sócio (Opcional)</label>
                            <select class="form-control" id="modalPreCobrancaSocioSelect" name="socioId">
                                <option value="">Selecione o sócio</option>
                                <option th:each="socio : ${socios}"
                                        th:value="${socio.id}"
                                        th:text="${socio.nome}"></option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="salvarNovaPreCobranca">Salvar Pré-Cobrança</button>
                </div>
            </div>
        </div>
    </div>

</div>
<th:block th:fragment="pageScripts">
    <script th:inline="javascript">
        $(document).ready(function() {
            // Inicializa o maskMoney no campo de valor
            $('#valorDisplay').maskMoney({
                prefix: 'R$ ',
                thousands: '.',
                decimal: ',',
                allowEmpty: false
            });

            // Inicializa o datepicker no campo de data
            $('#dataPagamento').datetimepicker({
                format: 'YYYY-MM-DD'
            });

            // Pega o valor inicial do campo oculto, que é populado pelo Thymeleaf
            const valorInicial = $('#valor').val();
            
            // Aplica a máscara no campo de exibição se o valor inicial existir
            if (valorInicial) {
                // Substitui o ponto por vírgula para o maskMoney entender
                const valorFormatado = valorInicial.replace('.', ',');
                $('#valorDisplay').val(valorFormatado);
                $('#valorDisplay').maskMoney('mask');
            }

            // Garante que o campo de data seja exibido com o valor correto
            const dataPagamentoInicial = $('#dataPagamento').val();
            if (dataPagamentoInicial) {
                $('#dataPagamento').val(dataPagamentoInicial);
            }

            // Intercepta o envio do formulário para "desmascarar" o valor antes de submeter
            $('#pagamentoForm').submit(function() {
                const valorNumerico = $('#valorDisplay').maskMoney('unmasked')[0];
                $('#valor').val(valorNumerico);
            });

            // Function to update the total selected value
            function updateTotalSelected() {
                let total = 0;
                $('.cobranca-checkbox:checked').each(function() {
                    total += parseFloat($(this).data('valor'));
                });
                $('#total-selecionado').text('R$ ' + total.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
            }

            // Attach change event listener to checkboxes
            $('.cobranca-checkbox').on('change', updateTotalSelected);

            // Initial calculation on page load
            updateTotalSelected();
        });
    </script>
    <script>
        // Script para o modal de Adicionar Nova Conta a Receber
        $(document).ready(function() {
            // Inicializa o maskMoney no campo de valor do modal
            $("#modalValorInput").maskMoney({
                prefix: "R$ ",
                thousands: ".",
                decimal: ",",
                allowEmpty: true,
            });

            // Inicializa o datetimepicker no campo de data do modal
            $('#modalDataVencimentoInput').datetimepicker({
                format: 'YYYY-MM-DD'
            });

            // O código abaixo resolve o problema de submissão para o modal.
            $('#novaContaReceberForm').submit(function() {
                // Obtém o valor numérico desmascarado do campo visível do modal
                let valorNumerico = $('#modalValorInput').maskMoney('unmasked')[0];
                // Seta o valor numérico no campo oculto do modal
                $('#modalValorInputHidden').val(valorNumerico);
            });

            // Lidar com o clique do botão Salvar Conta do modal
            $('#salvarNovaContaReceber').on('click', function(e) {
                e.preventDefault(); // Previne o comportamento padrão do botão

                // Dispara o evento de submit do formulário para que o maskMoney possa desmascarar o valor
                $('#novaContaReceberForm').trigger('submit');

                const rubricaId = $('#modalRubricaSelect').val();
                const descricao = $('#modalDescricaoInput').val();
                const dataVencimento = $('#modalDataVencimentoInput').val();
                const valor = $('#modalValorInputHidden').val(); // Pega o valor já desmascarado

                // Validação básica
                if (!rubricaId || !descricao || !dataVencimento || !valor) {
                    alert('Por favor, preencha todos os campos obrigatórios.');
                    return;
                }

                const socioId = $('#currentSocioId').val(); // Get socioId from hidden input
                const data = {
                    rubricaId: rubricaId,
                    descricao: descricao,
                    dataVencimento: dataVencimento,
                    valor: parseFloat(valor), // Converte para número
                    socioId: socioId // Pass socioId
                };

                $.ajax({
                    url: '/cobrancas/criar',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function(response) {
                        alert('Conta a receber salva com sucesso! A página será recarregada para exibir todas as cobranças atualizadas.');
                        $('#novaContaReceberModal').modal('hide'); // Fecha o modal
                        location.reload(); // Recarrega a página para exibir a nova conta e todas as cobranças atualizadas
                    },
                    error: function(xhr, status, error) {
                        alert('Erro ao salvar conta a receber: ' + xhr.responseText);
                        console.error('Erro ao salvar conta a receber:', xhr.responseText);
                    }
                });
            });
        });
    </script>
    <script>
        // Script para o modal de Adicionar Nova Pré-Cobrança
        $(document).ready(function() {
            // Inicializa o maskMoney no campo de valor do modal
            $("#modalPreCobrancaValorInput").maskMoney({
                prefix: "R$ ",
                thousands: ".",
                decimal: ",",
                allowEmpty: true,
            });

            // Inicializa o datetimepicker no campo de data do modal
            $('#modalPreCobrancaDataVencimentoInput').datetimepicker({
                format: 'YYYY-MM-DD'
            });

            // O código abaixo resolve o problema de submissão para o modal.
            $('#novaPreCobrancaForm').submit(function() {
                // Obtém o valor numérico desmascarado do campo visível do modal
                let valorNumerico = $('#modalPreCobrancaValorInput').maskMoney('unmasked')[0];
                // Seta o valor numérico no campo oculto do modal
                $('#modalPreCobrancaValorInputHidden').val(valorNumerico);
            });

            // Lidar com o clique do botão Salvar Pré-Cobrança do modal
            $('#salvarNovaPreCobranca').on('click', function(e) {
                e.preventDefault(); // Previne o comportamento padrão do botão

                // Dispara o evento de submit do formulário para que o maskMoney possa desmascarar o valor
                $('#novaPreCobrancaForm').trigger('submit');

                const valor = $('#modalPreCobrancaValorInputHidden').val();
                const descricao = $('#modalPreCobrancaDescricaoInput').val();
                const dataVencimento = $('#modalPreCobrancaDataVencimentoInput').val();
                const rubricaId = $('#modalPreCobrancaRubricaSelect').val();
                const tipoCobranca = $('#modalPreCobrancaTipoCobrancaSelect').val();
                const socioId = $('#modalPreCobrancaSocioSelect').val();

                // Validação básica
                if (!valor || !descricao || !dataVencimento || !rubricaId || !tipoCobranca) {
                    alert('Por favor, preencha todos os campos obrigatórios para a Pré-Cobrança.');
                    return;
                }

                const data = {
                    valor: parseFloat(valor),
                    descricao: descricao,
                    dataVencimento: dataVencimento,
                    rubricaId: rubricaId,
                    tipoCobranca: tipoCobranca,
                    socioId: socioId || null // socioId é opcional
                };

                $.ajax({
                    url: '/cobrancas/pre-criar',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function(response) {
                        alert('Pré-Cobrança salva com sucesso!');
                        $('#novaPreCobrancaModal').modal('hide'); // Fecha o modal
                        // Adicionar a nova pré-cobrança à lista na página
                        const newRow = `
                            <tr>
                                <td><input type="checkbox" class="pre-cobranca-checkbox" data-id="${response.id}" data-valor="${response.valor}" /></td>
                                <td>${response.descricao}</td>
                                <td>${response.dataVencimento}</td>
                                <td>R$ ${response.valor.toFixed(2).replace('.', ',')}</td>
                                <td>${response.tipoCobranca}</td>
                                <td>${response.socioNome ? response.socioNome : 'N/A'}</td> <!-- Display socioName if available, otherwise 'N/A' -->
                            </tr>
                        `;
                        $('#preCobrancasList tbody').append(newRow);
                    },
                    error: function(xhr, status, error) {
                        alert('Erro ao salvar pré-cobrança: ' + xhr.responseText);
                        console.error('Erro ao salvar pré-cobrança:', xhr.responseText);
                    }
                });
            });
        });
    </script>
</th:block>
</body>
</html>