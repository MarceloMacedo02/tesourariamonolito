<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    th:replace="~{layout(titulo='Registrar Recebimento de Crédito', content=~{::content}, pageScripts=~{::pageScripts})}">

<head>
    <title>Registrar Recebimento de Crédito</title>
</head>

<body>
    <div th:fragment="content">
        <input type="hidden" id="currentSocioId"
            th:value="${transacao.tipoRelacionamento == T(br.com.sigest.tesouraria.domain.enums.TipoRelacionamento).SOCIO ? transacao.relacionadoId : ''}" />
        <input type="hidden" id="currentSocioNome"
            th:value="${transacao.tipoRelacionamento == T(br.com.sigest.tesouraria.domain.enums.TipoRelacionamento).SOCIO ? transacao.fornecedorOuSocio : ''}" />
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">Registrar Recebimento de Crédito</h1>
            <div>
                <a th:if="${fromTitular != null}" th:href="@{/cobrancas/pagar/{id}(id=${fromTitular})}"
                    class="btn btn-info">Voltar ao Sócio Titular</a>
                <a th:href="@{/transacoes/review}" class="btn btn-secondary">Voltar para a Lista</a>
            </div>
        </div>

        <div th:if="${warning}" class="alert alert-warning" role="alert" th:text="${warning}"></div>

        <div class="card mb-4">
            <div class="card-header">
                Detalhes da Transação de Crédito
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-3">ID</dt>
                    <dd class="col-sm-9" th:text="${transacao.id}"></dd>

                    <dt class="col-sm-3">Pagador</dt>
                    <dd class="col-sm-9"
                        th:text="${transacao.fornecedorOuSocio}"></dd>

                    <dt class="col-sm-3">Valor</dt>
                    <dd class="col-sm-9"
                        th:text="${'R$ ' + #numbers.formatDecimal(transacao.valor, 0, 'POINT', 2, 'POINT')}"></dd>
                    <input type="hidden" id="transacaoValor" th:value="${transacao.valor}" />

                    <dt class="col-sm-3">Descrição</dt>
                    <dd class="col-sm-9" th:text="${transacao.descricao}"></dd>

                    <dt class="col-sm-3">Data</dt>
                    <dd class="col-sm-9" th:text="${#temporals.format(transacao.data, 'dd/MM/yyyy')}"></dd>
                    
                    <!-- Se a transação não estiver associada a um sócio, mostrar opção para associar -->
                    <dt class="col-sm-3" th:if="${transacao.tipoRelacionamento != T(br.com.sigest.tesouraria.domain.enums.TipoRelacionamento).SOCIO}">Associar Sócio</dt>
                    <dd class="col-sm-9" th:if="${transacao.tipoRelacionamento != T(br.com.sigest.tesouraria.domain.enums.TipoRelacionamento).SOCIO}">
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#associarSocioModal">
                            Associar Sócio à Transação
                        </button>
                    </dd>
                </dl>
            </div>
        </div>

        <!-- Nova Seção: Contas a Receber -->
        <div class="card mt-4">
            <div class="card-header">
                Contas a Receber do Sócio
                <span class="float-end">Total Selecionado: <span id="total-contas-receber-selecionado">R$
                        0,00</span></span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th></th> <!-- Checkbox column -->
                                <th>Descrição</th>
                                <th>Vencimento</th>
                                <th>Valor</th>
                                <th>Tipo</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Contas a receber serão carregadas aqui via Thymeleaf/JavaScript -->
                            <tr th:each="contaReceber : ${contasAReceber}">
                                <td>
                                    <input type="checkbox" class="conta-receber-checkbox"
                                        th:data-valor="${contaReceber.valor}" th:data-id="${contaReceber.id}" />
                                </td>
                                <td th:text="${contaReceber.descricao}"></td>
                                <td th:text="${#temporals.format(contaReceber.dataVencimento, 'dd/MM/yyyy')}"></td>
                                <td
                                    th:text="${'R$ ' + #numbers.formatDecimal(contaReceber.valor, 0, 'POINT', 2, 'POINT')}">
                                </td>
                                <td th:text="${contaReceber.tipoCobranca}"></td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(contasAReceber)}">
                                <td colspan="4" class="text-center">Nenhuma conta a receber encontrada para o sócio.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="text-end mt-3">
                    <button type="button" class="btn btn-success" data-bs-toggle="modal"
                        data-bs-target="#novaContaReceberModal">
                        Adicionar Nova Conta a Receber
                    </button>
                    <!-- <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                        data-bs-target="#novaPreCobrancaModal">
                        Adicionar Pré-Cobrança
                    </button> -->
                </div>
            </div>
        </div>

        <!-- Seção de Pré-Cobranças -->


        <!-- Seção de Todas as Cobranças em Aberto do Sócio e Dependentes -->
        <div class="card mt-4" th:if="${allOpenCobrancas != null and not #lists.isEmpty(allOpenCobrancas)}">
            <div class="card-header">
                Todas as Cobranças em Aberto do Sócio e Dependentes
                <span class="float-end">Total Selecionado: <span id="total-selecionado">R$ 0,00</span></span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th></th> <!-- New Checkbox column header -->
                                <th>Sócio/Dependente</th>
                                <th>Descrição</th>
                                <th>Vencimento</th>
                                <th>Valor</th>
                                <th>Tipo</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="cobrancaDep : ${allOpenCobrancas}">
                                <td>
                                    <input type="checkbox" class="cobranca-checkbox"
                                        th:data-valor="${cobrancaDep.valor}" th:data-id="${cobrancaDep.id}" />
                                </td>
                                <td th:text="${cobrancaDep.socio != null ? cobrancaDep.socio.nome : 'N/A'}"></td>
                                <td th:text="${cobrancaDep.descricao}"></td>
                                <td th:text="${#temporals.format(cobrancaDep.dataVencimento, 'dd/MM/yyyy')}"></td>
                                <td
                                    th:text="${'R$ ' + #numbers.formatDecimal(cobrancaDep.valor, 0, 'POINT', 2, 'POINT')}">
                                </td>
                                <td th:text="${cobrancaDep.tipoCobranca}"></td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(allOpenCobrancas)}">
                                <td colspan="5" class="text-center">Nenhuma cobrança em aberto para o sócio ou seus
                                    dependentes.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div th:if="${allOpenCobrancas == null or #lists.isEmpty(allOpenCobrancas)}" class="alert alert-info mt-3">
            Nenhuma cobrança em aberto encontrada para o sócio ou seus dependentes.
        </div>

        <div class="card mt-4">
            <div class="card-header">
                Valor Total de Contas a Receber (Mensalidades e Outras Receitas)
            </div>
            <div class="card-body text-center fs-4 fw-bold">
                Total Geral: <span id="grand-total-receber">R$ 0,00</span>
            </div>
        </div>

        <!-- Nova Seção: Baixa da Transação -->
        <div class="card mt-4">
            <div class="card-header">
                Baixa da Transação
            </div>
            <div class="card-body">
                <form id="baixaTransacaoForm">
                    <div class="mb-3">
                        <label for="contaFinanceiraSelect" class="form-label">Conta Financeira</label>
                        <select class="form-control" id="contaFinanceiraSelect" name="contaFinanceiraId" required>
                            <option value="">Selecione a Conta Financeira</option>
                            <option th:each="conta : ${contasFinanceiras}" th:value="${conta.id}"
                                th:text="${conta.nome}"></option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary" id="quitar-cobrancas-selecionadas">
                        Quitar Cobranças Selecionadas
                    </button>
                </form>
            </div>
        </div>

        <!-- Modal para Adicionar Nova Conta a Receber -->
        <div class="modal fade" id="novaContaReceberModal" tabindex="-1" aria-labelledby="novaContaReceberModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="novaContaReceberModalLabel">Adicionar Nova Conta a Receber</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="novaContaReceberForm">
                            <div class="mb-3">
                                <label for="modalRubricaSelect" class="form-label">Rubrica</label>
                                <select class="form-control" id="modalRubricaSelect" required name="rubricaId">
                                    <option value="">Selecione a rubrica</option>
                                    <option th:each="rubrica : ${rubricas}" th:value="${rubrica.id}"
                                        th:text="${rubrica.nome}"></option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="modalDescricaoInput" class="form-label">Descrição</label>
                                <input type="text" class="form-control" id="modalDescricaoInput" required
                                    name="descricao" />
                            </div>
                            <div class="mb-3">
                                <label for="modalDataVencimentoInput" class="form-label">Data de Vencimento</label>
                                <input type="text" class="form-control" id="modalDataVencimentoInput" required
                                    name="dataVencimento" />
                            </div>
                            <div class="mb-3">
                                <label for="modalValorInput" class="form-label">Valor</label>
                                <input type="text" class="form-control" id="modalValorInput" required />
                                <input type="hidden" id="modalValorInputHidden" name="valor" />
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="salvarNovaContaReceber">Salvar Conta</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para Adicionar Nova Pré-Cobrança -->
        <div class="modal fade" id="novaPreCobrancaModal" tabindex="-1" aria-labelledby="novaPreCobrancaModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="novaPreCobrancaModalLabel">Adicionar Nova Pré-Cobrança</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="novaPreCobrancaForm">
                            <div class="mb-3">
                                <label for="modalPreCobrancaValorInput" class="form-label">Valor</label>
                                <input type="text" class="form-control" id="modalPreCobrancaValorInput" required />
                                <input type="hidden" id="modalPreCobrancaValorInputHidden" name="valor" />
                            </div>
                            <div class="mb-3">
                                <label for="modalPreCobrancaDescricaoInput" class="form-label">Descrição</label>
                                <input type="text" class="form-control" id="modalPreCobrancaDescricaoInput" required
                                    name="descricao" />
                            </div>
                            <div class="mb-3">
                                <label for="modalPreCobrancaDataVencimentoInput" class="form-label">Data de
                                    Vencimento</label>
                                <input type="text" class="form-control" id="modalPreCobrancaDataVencimentoInput"
                                    required name="dataVencimento" />
                            </div>
                            <div class="mb-3">
                                <label for="modalPreCobrancaRubricaSelect" class="form-label">Rubrica</label>
                                <select class="form-control" id="modalPreCobrancaRubricaSelect" required
                                    name="rubricaId">
                                    <option value="">Selecione a rubrica</option>
                                    <option th:each="rubrica : ${rubricas}" th:value="${rubrica.id}"
                                        th:text="${rubrica.nome}"></option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="modalPreCobrancaTipoCobrancaSelect" class="form-label">Tipo de
                                    Cobrança</label>
                                <select class="form-control" id="modalPreCobrancaTipoCobrancaSelect" required
                                    name="tipoCobranca">
                                    <option value="">Selecione o tipo</option>
                                    <option value="MENSALIDADE">Mensalidade</option>
                                    <option value="OUTRAS_RUBRICAS">Outras Rubricas</option>
                                    <option value="AVULSA">Avulsa</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="modalPreCobrancaSocioSelect" class="form-label">Sócio (Opcional)</label>
                                <select class="form-control" id="modalPreCobrancaSocioSelect" name="socioId">
                                    <option value="">Selecione o sócio</option>
                                    <option th:each="socio : ${socios}" th:value="${socio.id}" th:text="${socio.nome}">
                                    </option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="salvarNovaPreCobranca">Salvar
                            Pré-Cobrança</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <th:block th:fragment="pageScripts">
        <script th:inline="javascript">
            function showCustomToast(message, type) {
                const toastContainer = document.querySelector('.position-fixed.top-0.end-0.p-3'); // Assuming this is the toast container from layout.html
                if (!toastContainer) {
                    console.error('Toast container not found. Falling back to alert.');
                    alert(message);
                    return;
                }

                // Create a new toast element
                const toastElement = document.createElement('div');
                toastElement.classList.add('toast', 'align-items-center', 'border-0');
                toastElement.setAttribute('role', 'alert');
                toastElement.setAttribute('aria-live', 'assertive');
                toastElement.setAttribute('aria-atomic', 'true');

                let bgColorClass = '';
                let iconClass = '';
                let headerText = '';

                switch (type) {
                    case 'success':
                        bgColorClass = 'text-bg-success';
                        iconClass = 'feather-check-circle';
                        headerText = 'Sucesso!';
                        break;
                    case 'error':
                        bgColorClass = 'text-bg-danger';
                        iconClass = 'feather-alert-octagon';
                        headerText = 'Erro!';
                        break;
                    case 'warning':
                        bgColorClass = 'text-bg-warning';
                        iconClass = 'feather-alert-triangle';
                        headerText = 'Aviso!';
                        break;
                    case 'info':
                        bgColorClass = 'text-bg-info'; // Assuming info toast style
                        iconClass = 'feather-info'; // Assuming info icon
                        headerText = 'Informação!';
                        break;
                    default:
                        bgColorClass = 'text-bg-primary'; // Default to primary if type is unknown
                        iconClass = 'feather-bell'; // Default icon
                        headerText = 'Notificação!';
                }

                toastElement.classList.add(bgColorClass);

                toastElement.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="${iconClass}"></i>
                            <span>${message}</span>
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                `;

                toastContainer.appendChild(toastElement);

                const toast = new bootstrap.Toast(toastElement);
                toast.show();

                // Remove toast element after it's hidden
                toastElement.addEventListener('hidden.bs.toast', function () {
                    toastElement.remove();
                });
            }

            $(document).ready(function () {
                // Inicializa o maskMoney no campo de valor
                $('#valorDisplay').maskMoney({
                    prefix: 'R$ ',
                    thousands: '.',
                    decimal: ',',
                    allowEmpty: false
                });

                // Inicializa o datepicker no campo de data
                $('#dataPagamento').datetimepicker({
                    format: 'YYYY-MM-DD'
                });

                // Pega o valor inicial do campo oculto, que é populado pelo Thymeleaf
                const valorInicial = $('#valor').val();

                // Aplica a máscara no campo de exibição se o valor inicial existir
                if (valorInicial) {
                    // Substitui o ponto por vírgula para o maskMoney entender
                    const valorFormatado = valorInicial.replace('.', ',');
                    $('#valorDisplay').val(valorFormatado);
                    $('#valorDisplay').maskMoney('mask');
                }

                // Garante que o campo de data seja exibido com o valor correto
                const dataPagamentoInicial = $('#dataPagamento').val();
                if (dataPagamentoInicial) {
                    $('#dataPagamento').val(dataPagamentoInicial);
                }

                // Intercepta o envio do formulário para "desmascarar" o valor antes de submeter
                $('#pagamentoForm').submit(function () {
                    const valorNumerico = $('#valorDisplay').maskMoney('unmasked')[0];
                    $('#valor').val(valorNumerico);
                });

                // Array to store selected billing IDs
                let selectedCobrancaIds = [];

                // Function to update the selected billing IDs list
                function updateSelectedCobrancaIds(checkbox, isChecked) {
                    const cobrancaId = $(checkbox).data('id');
                    
                    if (isChecked) {
                        // Add ID to the list if not already present
                        if (!selectedCobrancaIds.includes(cobrancaId)) {
                            selectedCobrancaIds.push(cobrancaId);
                        }
                    } else {
                        // Remove ID from the list
                        selectedCobrancaIds = selectedCobrancaIds.filter(id => id !== cobrancaId);
                    }
                    
                    console.log('Selected cobranca IDs:', selectedCobrancaIds);
                }

                // Function to update the total selected value for cobrancas
                function updateTotalCobrancasSelected() {
                    let total = 0;
                    $('.cobranca-checkbox:checked').each(function () {
                        // Verificar se o elemento realmente está selecionado
                        if ($(this).is(':checked')) {
                            total += parseFloat($(this).data('valor'));
                        }
                    });
                    return total;
                }

                // Function to update the total selected value for contas a receber
                function updateTotalContasReceberSelected() {
                    let total = 0;
                    $('.conta-receber-checkbox:checked').each(function () {
                        // Verificar se o elemento realmente está selecionado
                        if ($(this).is(':checked')) {
                            total += parseFloat($(this).data('valor'));
                        }
                    });
                    return total;
                }

                // Function to update all totals for individual sections and the grand total
                function updateAllTotals() {
                    const totalCobrancas = updateTotalCobrancasSelected();
                    const totalContasReceber = updateTotalContasReceberSelected();

                    // Update individual labels
                    $('#total-selecionado').text('R$ ' + totalCobrancas.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
                    $('#total-contas-receber-selecionado').text('R$ ' + totalContasReceber.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));

                    // Update the grand total of all *selected* receivable charges
                    const grandTotal = totalCobrancas + totalContasReceber;
                    $('#grand-total-receber').text('R$ ' + grandTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));

                    // Call validation function after totals are updated
                    validateBaixaForm();
                }

                // Function to validate the baixa form
                function validateBaixaForm() {
                    const transacaoValor = parseFloat($('#transacaoValor').val());
                    // Parse the grand total from the displayed text, removing currency symbol and handling locale-specific decimal/thousands separators
                    const grandTotalReceber = parseFloat($('#grand-total-receber').text().replace('R$ ', '').replace('.', '').replace(',', '.'));
                    const contaFinanceiraSelected = $('#contaFinanceiraSelect').val() !== '';
                    const button = $('#quitar-cobrancas-selecionadas');

                    // Use a small tolerance for floating-point comparison due to potential precision issues
                    const tolerance = 0.001;
                    const isTotalMatching = Math.abs(grandTotalReceber - transacaoValor) < tolerance;

                    // Enable button only if total matches and a financial account is selected
                    if (isTotalMatching && contaFinanceiraSelected && selectedCobrancaIds.length > 0) {
                        button.prop('disabled', false);
                    } else {
                        button.prop('disabled', true);
                    }
                }

                // Attach change event listener to all relevant checkboxes
                $('.cobranca-checkbox, .conta-receber-checkbox').on('change', function() {
                    // Update the selected IDs list
                    updateSelectedCobrancaIds(this, $(this).is(':checked'));
                    
                    // Atualizar os totais quando um checkbox for alterado
                    updateAllTotals();
                });

                // Attach change event listener to the conta financeira select
                $('#contaFinanceiraSelect').on('change', validateBaixaForm);

                // Initialize the selectedCobrancaIds array with any pre-selected checkboxes
                $('.cobranca-checkbox:checked, .conta-receber-checkbox:checked').each(function() {
                    updateSelectedCobrancaIds(this, true);
                });

                // Initial calculation and validation on page load
                updateAllTotals();
                validateBaixaForm();

                // Handle click on "Quitar Cobranças Selecionadas" button
                $('#quitar-cobrancas-selecionadas').on('click', function () {
                    const transacaoId = /*[[${transacao.id}]]*/ null; // Get the transaction ID from Thymeleaf
                    const contaFinanceiraId = $('#contaFinanceiraSelect').val();

                    if (selectedCobrancaIds.length === 0) {
                        showCustomToast('Por favor, selecione ao menos uma cobrança para quitar.', 'warning');
                        return;
                    }

                    if (!transacaoId) {
                        showCustomToast('Erro: ID da transação não encontrado.', 'error');
                        return;
                    }

                    if (!contaFinanceiraId) {
                        showCustomToast('Por favor, selecione uma Conta Financeira.', 'warning');
                        return;
                    }

                    // Send IDs and contaFinanceiraId to the backend
                    const csrfToken = $("meta[name='_csrf']").attr("content");
                    const csrfHeader = $("meta[name='_csrf_header']").attr("content");

                    $.ajax({
                        url: '/transacoes/' + transacaoId + '/quitar-cobrancas',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            cobrancaIds: selectedCobrancaIds,
                            contaFinanceiraId: contaFinanceiraId
                        }),
                        beforeSend: function (xhr) {
                            xhr.setRequestHeader(csrfHeader, csrfToken);
                        },
                        success: function (response) {
                            showCustomToast('Cobranças quitadas com sucesso!', 'success');
                            location.reload(); // Reload page to reflect changes
                        },
                        error: function (xhr, status, error) {
                            showCustomToast('Erro ao quitar cobranças: ' + xhr.responseText, 'error');
                            console.error('Erro ao quitar cobranças:', xhr.responseText);
                        }
                    });
                });
            });
        </script>
        <script>
            // Script para o modal de Adicionar Nova Conta a Receber
            $(document).ready(function () {
                // Inicializa o maskMoney no campo de valor do modal
                $("#modalValorInput").maskMoney({
                    prefix: "R$ ",
                    thousands: ".",
                    decimal: ",",
                    allowEmpty: true,
                });

                // Inicializa o datetimepicker no campo de data do modal
                $('#modalDataVencimentoInput').datetimepicker({
                    format: 'YYYY-MM-DD'
                });

                // O código abaixo resolve o problema de submissão para o modal.
                $('#novaContaReceberForm').submit(function () {
                    // Obtém o valor numérico desmascarado do campo visível do modal
                    let valorNumerico = $('#modalValorInput').maskMoney('unmasked')[0];
                    // Seta o valor numérico no campo oculto do modal
                    $('#modalValorInputHidden').val(valorNumerico);
                });

                // Lidar com o clique do botão Salvar Conta do modal
                $('#salvarNovaContaReceber').on('click', function (e) {
                    e.preventDefault(); // Previne o comportamento padrão do botão

                    // Dispara o evento de submit do formulário para que o maskMoney possa desmascarar o valor
                    $('#novaContaReceberForm').trigger('submit');

                    const rubricaId = $('#modalRubricaSelect').val();
                    const descricao = $('#modalDescricaoInput').val();
                    const dataVencimento = $('#modalDataVencimentoInput').val();
                    const valor = $('#modalValorInputHidden').val(); // Pega o valor já desmascarado

                    // Validação básica
                    if (!rubricaId || !descricao || !dataVencimento || !valor) {
                        showCustomToast('Por favor, preencha todos os campos obrigatórios.', 'warning');
                        return;
                    }

                    const socioId = $('#currentSocioId').val() || ($('#socioSelect').val() && $('#socioSelect').val() !== '' ? $('#socioSelect').val() : null); // Get socioId from hidden input or association modal
                    const data = {
                        rubricaId: rubricaId,
                        descricao: descricao,
                        dataVencimento: dataVencimento,
                        valor: parseFloat(valor), // Converte para número
                        socioId: socioId // Pass socioId
                    };

                    $.ajax({
                        url: '/cobrancas/criar',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(data),
                        success: function (response) {
                            showCustomToast('Conta a receber salva com sucesso! A página será recarregada para exibir todas as cobranças atualizadas.', 'success');
                            $('#novaContaReceberModal').modal('hide'); // Fecha o modal
                            location.reload(); // Recarrega a página para exibir a nova conta e todas as cobranças atualizadas
                        },
                        error: function (xhr, status, error) {
                            showCustomToast('Erro ao salvar conta a receber: ' + xhr.responseText, 'error');
                            console.error('Erro ao salvar conta a receber:', xhr.responseText);
                        }
                    });
                });
            });
        </script>
        <script>
            // Script para o modal de Adicionar Nova Pré-Cobrança
            $(document).ready(function () {
                // Inicializa o maskMoney no campo de valor do modal
                $("#modalPreCobrancaValorInput").maskMoney({
                    prefix: "R$ ",
                    thousands: ".",
                    decimal: ",",
                    allowEmpty: true,
                });

                // Inicializa o datetimepicker no campo de data do modal
                $('#modalPreCobrancaDataVencimentoInput').datetimepicker({
                    format: 'YYYY-MM-DD'
                });

                // O código abaixo resolve o problema de submissão para o modal.
                $('#novaPreCobrancaForm').submit(function () {
                    // Obtém o valor numérico desmascarado do campo visível do modal
                    let valorNumerico = $('#modalPreCobrancaValorInput').maskMoney('unmasked')[0];
                    // Seta o valor numérico no campo oculto do modal
                    $('#modalPreCobrancaValorInputHidden').val(valorNumerico);
                });

                // Lidar com o clique do botão Salvar Pré-Cobrança do modal
                $('#salvarNovaPreCobranca').on('click', function (e) {
                    e.preventDefault(); // Previne o comportamento padrão do botão

                    // Dispara o evento de submit do formulário para que o maskMoney possa desmascarar o valor
                    $('#novaPreCobrancaForm').trigger('submit');

                    const valor = $('#modalPreCobrancaValorInputHidden').val();
                    const descricao = $('#modalPreCobrancaDescricaoInput').val();
                    const dataVencimento = $('#modalPreCobrancaDataVencimentoInput').val();
                    const rubricaId = $('#modalPreCobrancaRubricaSelect').val();
                    const tipoCobranca = $('#modalPreCobrancaTipoCobrancaSelect').val();
                    const socioId = $('#modalPreCobrancaSocioSelect').val();

                    // Validação básica
                    if (!valor || !descricao || !dataVencimento || !rubricaId || !tipoCobranca) {
                        showCustomToast('Por favor, preencha todos os campos obrigatórios para a Pré-Cobrança.', 'warning');
                        return;
                    }

                    const data = {
                        valor: parseFloat(valor),
                        descricao: descricao,
                        dataVencimento: dataVencimento,
                        rubricaId: rubricaId,
                        tipoCobranca: tipoCobranca,
                        socioId: socioId || null // socioId é opcional
                    };

                    $.ajax({
                        url: '/cobrancas/pre-criar',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(data),
                        success: function (response) {
                            showCustomToast('Pré-Cobrança salva com sucesso!', 'success');
                            $('#novaPreCobrancaModal').modal('hide'); // Fecha o modal
                            // Adicionar a nova pré-cobrança à lista na página
                            const newRow = `
                            <tr>
                                <td><input type="checkbox" class="pre-cobranca-checkbox" data-id="${response.id}" data-valor="${response.valor}" /></td>
                                <td>${response.descricao}</td>
                                <td>${response.dataVencimento}</td>
                                <td>R$ ${response.valor.toFixed(2).replace('.', ',')}</td>
                                <td>${response.tipoCobranca}</td>
                                <td>${response.socioNome ? response.socioNome : 'N/A'}</td> <!-- Display socioName if available, otherwise 'N/A' -->
                            </tr>
                        `;
                            $('#preCobrancasList tbody').append(newRow);
                        },
                        error: function (xhr, status, error) {
                            showCustomToast('Erro ao salvar pré-cobrança: ' + xhr.responseText, 'error');
                            console.error('Erro ao salvar pré-cobrança:', xhr.responseText);
                        }
                    });
                });
            });
        </script>
        
        <!-- Script para associar sócio à transação -->
        <script>
            $(document).ready(function () {
                // Handle click on "Confirmar Associação Sócio" button
                $('#confirmarAssociacaoSocio').on('click', function () {
                    const transacaoId = /*[[${transacao.id}]]*/ null; // Get the transaction ID from Thymeleaf
                    const socioId = $('#socioSelect').val();
                    
                    if (!transacaoId) {
                        showCustomToast('Erro: ID da transação não encontrado.', 'error');
                        return;
                    }
                    
                    if (!socioId) {
                        showCustomToast('Por favor, selecione um sócio.', 'warning');
                        return;
                    }
                    
                    // Send request to associate socio with transaction
                    const csrfToken = $("meta[name='_csrf']").attr("content");
                    const csrfHeader = $("meta[name='_csrf_header']").attr("content");
                    
                    $.ajax({
                        url: '/transacoes/' + transacaoId + '/associar-socio',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            socioId: socioId
                        }),
                        beforeSend: function (xhr) {
                            xhr.setRequestHeader(csrfHeader, csrfToken);
                        },
                        success: function (response) {
                            showCustomToast('Sócio associado com sucesso!', 'success');
                            $('#associarSocioModal').modal('hide'); // Close modal
                            // Update the hidden input with the new socio ID
                            $('#currentSocioId').val(socioId);
                            $('#currentSocioNome').val($('#socioSelect option:selected').text());
                            location.reload(); // Reload page to reflect changes
                        },
                        error: function (xhr, status, error) {
                            showCustomToast('Erro ao associar sócio: ' + xhr.responseText, 'error');
                            console.error('Erro ao associar sócio:', xhr.responseText);
                        }
                    });
                });
            });
        </script>
        
        <!-- Modal para Associar Sócio à Transação -->
        <div class="modal fade" id="associarSocioModal" tabindex="-1" aria-labelledby="associarSocioModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="associarSocioModalLabel">Associar Sócio à Transação</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="associarSocioForm">
                            <div class="mb-3">
                                <label for="socioSelect" class="form-label">Selecione o Sócio</label>
                                <select class="form-control select2" id="socioSelect" required>
                                    <option value="">Selecione um sócio</option>
                                    <option th:each="socio : ${socios}" th:value="${socio.id}" th:text="${socio.nome}"></option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="confirmarAssociacaoSocio">Associar Sócio</button>
                    </div>
                </div>
            </div>
        </div>
    </th:block>
</body>

</html>