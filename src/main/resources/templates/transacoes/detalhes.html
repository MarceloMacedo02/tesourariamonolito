<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout(titulo='Registrar Pagamento', content=~{::content}, pageScripts=~{::pageScripts})}">
<head>
    <title>Registrar Pagamento</title>
</head>
<body>
<div th:fragment="content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">Registrar Pagamento de Cobranças</h1>
        <div>
            <a th:href="@{/cobrancas}" class="btn btn-secondary">Voltar para a Lista de Cobranças</a>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            Seleção de Sócio
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label for="socioSelect">Selecione o Sócio</label>
                        <select id="socioSelect" class="form-control">
                            <option value="">-- Selecione um Sócio --</option>
                            <!-- Socios will be loaded here via AJAX -->
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mt-4" id="cobrancasPendentesCard" style="display: none;">
        <div class="card-header">
            Cobranças em Aberto
        </div>
        <div class="card-body">
            <form id="pagamentoLoteForm" th:action="@{/cobrancas/registrar-pagamento-lote}" method="post">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllCobrancas"></th>
                                <th>Pagador</th>
                                <th>Descrição</th>
                                <th>Vencimento</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        <tbody id="cobrancasTableBody">
                            <!-- Cobranças will be loaded here via AJAX -->
                        </tbody>
                    </table>
                </div>

                <div class="row mt-3">
                    <div class="col-md-4">
                        <div class="form-group mb-3">
                            <label for="valorTotalDisplay">Valor Total Selecionado</label>
                            <input type="text" id="valorTotalDisplay" class="form-control" readonly/>
                            <input type="hidden" id="valorTotal" name="valorTotal"/>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group mb-3">
                            <label for="dataPagamento">Data do Pagamento</label>
                            <input type="text" id="dataPagamento" class="form-control" name="dataPagamento" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group mb-3">
                            <label for="contaFinanceiraSelect">Conta Financeira</label>
                            <select id="contaFinanceiraSelect" class="form-control" name="contaFinanceiraId" required>
                                <option value="">Selecione a conta</option>
                                <!-- Contas Financeiras will be loaded here via AJAX -->
                            </select>
                        </div>
                    </div>
                </div>

                <div class="text-end">
                    <button type="submit" class="btn btn-primary">Confirmar Pagamento das Selecionadas</button>
                </div>
            </form>
        </div>
    </div>
</div>

<th:block th:fragment="pageScripts">
    <script th:inline="javascript">
        $(document).ready(function() {
            // Initialize datetimepicker
            $('#dataPagamento').datetimepicker({
                format: 'YYYY-MM-DD'
            });

            // Load socios
            fetch('/api/socios/all') // Assuming an endpoint to get all socios
                .then(response => response.json())
                .then(data => {
                    const socioSelect = $('#socioSelect');
                    data.forEach(socio => {
                        socioSelect.append(`<option value="${socio.id}">${socio.nome}</option>`);
                    });
                })
                .catch(error => console.error('Erro ao carregar sócios:', error));

            // Load contas financeiras
            fetch('/api/contas-financeiras/all') // Assuming an endpoint to get all financial accounts
                .then(response => response.json())
                .then(data => {
                    const contaFinanceiraSelect = $('#contaFinanceiraSelect');
                    data.forEach(conta => {
                        contaFinanceiraSelect.append(`<option value="${conta.id}">${conta.nome}</option>`);
                    });
                })
                .catch(error => console.error('Erro ao carregar contas financeiras:', error));

            // Handle socio selection change
            $('#socioSelect').change(function() {
                const socioId = $(this).val();
                const cobrancasTableBody = $('#cobrancasTableBody');
                const cobrancasPendentesCard = $('#cobrancasPendentesCard');
                cobrancasTableBody.empty(); // Clear previous results
                cobrancasPendentesCard.hide(); // Hide card until data is loaded

                if (socioId) {
                    fetch(`/api/cobrancas/aberto-por-socio/${socioId}`) // New endpoint to get open charges for socio and dependents
                        .then(response => response.json())
                        .then(data => {
                            if (data.length > 0) {
                                data.forEach(cobranca => {
                                    cobrancasTableBody.append(`
                                        <tr>
                                            <td><input type="checkbox" class="cobranca-checkbox" name="cobrancaIds" value="${cobranca.id}" data-valor="${cobranca.valor}"></td>
                                            <td>${cobranca.socio ? cobranca.socio.nome : cobranca.pagador}</td>
                                            <td>${cobranca.descricao}</td>
                                            <td>${new Date(cobranca.dataVencimento).toLocaleDateString('pt-BR')}</td>
                                            <td>R$ ${cobranca.valor.toFixed(2).replace('.', ',')}</td>
                                        </tr>
                                    `);
                                });
                                cobrancasPendentesCard.show();
                            } else {
                                cobrancasTableBody.append(`<tr><td colspan="5" class="text-center">Nenhuma cobrança em aberto para este sócio e seus dependentes.</td></tr>`);
                                cobrancasPendentesCard.show();
                            }
                            updateTotalValue(); // Update total value initially
                        })
                        .catch(error => console.error('Erro ao carregar cobranças:', error));
                }
            });

            // Handle select all checkbox
            $('#selectAllCobrancas').change(function() {
                $('.cobranca-checkbox').prop('checked', $(this).prop('checked'));
                updateTotalValue();
            });

            // Handle individual checkbox change
            $(document).on('change', '.cobranca-checkbox', function() {
                updateTotalValue();
            });

            function updateTotalValue() {
                let total = 0;
                $('.cobranca-checkbox:checked').each(function() {
                    total += parseFloat($(this).data('valor'));
                });
                $('#valorTotalDisplay').val(`R$ ${total.toFixed(2).replace('.', ',')}`);
                $('#valorTotal').val(total.toFixed(2)); // For submission
            }

            // Intercept form submission for batch payment
            $('#pagamentoLoteForm').submit(function(event) {
                event.preventDefault();
                const selectedCobrancas = [];
                $('.cobranca-checkbox:checked').each(function() {
                    selectedCobrancas.push($(this).val());
                });

                if (selectedCobrancas.length === 0) {
                    alert('Selecione ao menos uma cobrança para quitar.');
                    return;
                }

                const formData = {
                    cobrancaIds: selectedCobrancas,
                    dataPagamento: $('#dataPagamento').val(),
                    contaFinanceiraId: $('#contaFinanceiraSelect').val(),
                    valorTotal: parseFloat($('#valorTotal').val())
                };

                fetch($(this).attr('th:action'), { // Use th:action for the URL
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => {
                    if (response.ok) {
                        alert('Cobranças quitadas com sucesso!');
                        // Optionally, reload the page or update the list
                        $('#socioSelect').trigger('change'); // Reload cobrancas for the selected socio
                    } else {
                        alert('Erro ao quitar cobranças.');
                    }
                })
                .catch(error => console.error('Erro ao submeter pagamento:', error));
            });
        });
    </script>
</th:block>
</body>
</html>