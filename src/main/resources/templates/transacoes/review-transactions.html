<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org"
  th:replace="~{layout(titulo='Revisar Transações OFX', content=~{::content}, pageScripts=~{::pageScripts})}">

<body>
  <div th:fragment="content">
    <div class="page-header">
      <div class="add-item d-flex">
        <div class="page-title">
          <h4>Revisar Transações OFX</h4>
          <h6>Verifique e categorize as transações importadas</h6>
        </div>
      </div>
    </div>

    <div th:if="${success}" class="alert alert-success mt-3" role="alert">
      <span th:text="${success}"></span>
    </div>
    <div th:if="${error}" class="alert alert-danger mt-3" role="alert">
      <span th:text="${error}"></span>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Transações de Crédito (Entradas)</h5>
            <div th:if="${creditTransacoes.empty}" class="alert alert-info">
              Nenhuma transação de crédito encontrada ou pendente de revisão.
            </div>
            <div th:unless="${creditTransacoes.empty}">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Data</th>
                    <th>Valor</th>
                    <th>Descrição</th>
                    <th>Sócio Identificado</th>
                    <th>Cobrancas Pendentes</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody>
                  <tr th:each="transacao : ${creditTransacoes}">
                    <td th:text="${#temporals.format(transacao.data, 'dd/MM/yyyy')}"></td>
                    <td th:text="${'R$ ' + #numbers.formatDecimal(transacao.valor, 0, 'POINT', 2, 'POINT')}"></td>
                    <td th:text="${transacao.descricao}"></td>
                    <td>
                      <span th:if="${transacao.socio != null}" th:text="${transacao.socio.nome}"></span>
                      <span th:if="${transacao.socio == null and !transacao.manualSelectionNeeded}">Não identificado</span>
                      <span th:if="${transacao.manualSelectionNeeded}">Aguardando seleção manual</span>
                    </td>
                    <td>
                        <ul th:if="${transacao.cobrancasPendentes != null and !transacao.cobrancasPendentes.empty}">
                            <li th:each="cobranca : ${transacao.cobrancasPendentes}">
                                <span th:text="${cobranca.descricao + ' - R$ ' + #numbers.formatDecimal(cobranca.valor, 0, 'POINT', 2, 'POINT')}"></span>
                            </li>
                        </ul>
                        <span th:if="${transacao.cobrancasPendentes == null or transacao.cobrancasPendentes.empty}">Nenhuma</span>
                    </td>
                    <td>
                      <div th:if="${transacao.manualSelectionNeeded}">
                        <form th:action="@{/transacoes/{id}/selecionar-parte(id=${transacao.id})}" method="post">
                          <input type="hidden" name="_method" value="put" />
                          <select name="selectedParty" class="form-select mb-2">
                            <option value="">Selecione...</option>
                            <optgroup label="Sócios" th:if="${transacao.socios != null and !transacao.socios.empty}">
                              <option th:each="socio : ${transacao.socios}" th:value="${'socio-' + socio.id}" th:text="${socio.nome}"></option>
                            </optgroup>
                          </select>
                          <button type="submit" class="btn btn-sm btn-success">Confirmar</button>
                        </form>
                      </div>
                      <a th:if="${!transacao.manualSelectionNeeded}" th:href="@{/transacoes/{id}/detalhes(id=${transacao.id})}" class="btn btn-sm btn-primary">Detalhes</a>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Transações de Débito (Saídas)</h5>
            <div th:if="${debitTransacoes.empty}" class="alert alert-info">
              Nenhuma transação de débito encontrada ou pendente de revisão.
            </div>
            <div th:unless="${debitTransacoes.empty}">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Data</th>
                    <th>Valor</th>
                    <th>Descrição</th>
                    <th>Fornecedor/Sócio Identificado</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody>
                  <tr th:each="transacao : ${debitTransacoes}">
                    <td th:text="${#temporals.format(transacao.data, 'dd/MM/yyyy')}"></td>
                    <td th:text="${'R$ ' + #numbers.formatDecimal(transacao.valor, 0, 'POINT', 2, 'POINT')}"></td>
                    <td th:text="${transacao.descricao}"></td>
                    <td>
                      <span th:if="${transacao.fornecedor != null}" th:text="${transacao.fornecedor.nome}"></span>
                      <span th:if="${transacao.socio != null}" th:text="${transacao.socio.nome}"></span>
                      <span th:if="${transacao.fornecedor == null and transacao.socio == null and !transacao.manualSelectionNeeded}">Não identificado</span>
                      <span th:if="${transacao.manualSelectionNeeded}">Aguardando seleção manual</span>
                    </td>
                    <td>
                      <div th:if="${transacao.manualSelectionNeeded}">
                        <form th:action="@{/transacoes/{id}/selecionar-parte(id=${transacao.id})}" method="post">
                          <input type="hidden" name="_method" value="put" />
                          <select name="selectedParty" class="form-select mb-2">
                            <option value="">Selecione...</option>
                            <optgroup label="Sócios" th:if="${transacao.socios != null and !transacao.socios.empty}">
                              <option th:each="socio : ${transacao.socios}" th:value="${'socio-' + socio.id}" th:text="${socio.nome}"></option>
                            </optgroup>
                            <optgroup label="Fornecedores" th:if="${transacao.fornecedores != null and !transacao.fornecedores.empty}">
                              <option th:each="fornecedor : ${transacao.fornecedores}" th:value="${'fornecedor-' + fornecedor.id}" th:text="${fornecedor.nome}"></option>
                            </optgroup>
                          </select>
                          <button type="submit" class="btn btn-sm btn-success">Confirmar</button>
                        </form>
                      </div>
                      <a th:if="${!transacao.manualSelectionNeeded}" th:href="@{/transacoes/{id}/detalhes(id=${transacao.id})}" class="btn btn-sm btn-primary">Detalhes</a>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>

<th:block th:fragment="pageScripts">
  <script>
    $(document).ready(function () {
      // Initialize DataTables for both tables if they exist
      if ($(".table").length > 0) {
        $(".table").DataTable({
          destroy: true,
          pageLength: 10 // Adjust as needed
        });
      }
    });
  </script>
</th:block>
</html>
