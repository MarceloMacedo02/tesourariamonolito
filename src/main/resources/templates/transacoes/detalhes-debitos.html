<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    th:replace="~{layout(titulo='Detalhes da Transação de Débito', content=~{::content}, pageScripts=~{::pageScripts})}">

<head>
    <title>Detalhes da Transação de Débito</title>
</head>

<body>
    <div th:fragment="content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">Detalhes da Transação de Débito</h1>
            <div th:if="${success}" class="alert alert-success mt-3" role="alert">
                <span th:text="${success}"></span>
            </div>
            <div th:if="${error}" class="alert alert-danger mt-3" role="alert">
                <span th:text="${error}"></span>
            </div>
            <div>
                <a th:href="@{/transacoes/review}" class="btn btn-secondary">Voltar para Revisão de Transações</a>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                Informações da Transação
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-3">ID</dt>
                    <dd class="col-sm-9" th:text="${transacao.id}"></dd>

                    <dt class="col-sm-3">Data</dt>
                    <dd class="col-sm-9" th:text="${transacao.data != null ? #temporals.format(transacao.data, 'dd/MM/yyyy') : 'Não definida'}"></dd>

                    <dt class="col-sm-3">Tipo</dt>
                    <dd class="col-sm-9" th:text="${transacao.tipo != null ? transacao.tipo.descricao : 'Não definido'}"></dd>

                    <dt class="col-sm-3">Valor</dt>
                    <dd class="col-sm-9"
                        th:text="${transacao.valor != null ? 'R$ ' + #numbers.formatDecimal(transacao.valor, 0, 'POINT', 2, 'POINT') : 'Não definido'}"></dd>

                    <dt class="col-sm-3">Descrição</dt>
                    <dd class="col-sm-9" th:text="${transacao.descricao}"></dd>

                    <dt class="col-sm-3">Fornecedor/Sócio</dt>
                    <dd class="col-sm-9" th:text="${transacao.fornecedorOuSocio}"></dd>

                    <dt class="col-sm-3">Documento</dt>
                    <dd class="col-sm-9" th:text="${transacao.documento}"></dd>

                    <dt class="col-sm-3">Status de Lançamento</dt>
                    <dd class="col-sm-9" th:text="${transacao.lancado != null ? transacao.lancado.descricao : 'Não definido'}"></dd>
                </dl>
            </div>
        </div>

        <div class="card mb-4" th:if="${transacao.lancado != null and transacao.lancado.name() != 'LANCADO'}">
            <div class="card-header">
                Cobranças Associadas
            </div>
            <div class="card-body">
                <form id="quitarCobrancasForm">
                    <div th:if="${transacao.fornecedorId == null and (transacao.tipoRelacionamento == null or (transacao.tipoRelacionamento != null and transacao.tipoRelacionamento.name() == 'NAO_ENCONTRADO'))}" class="alert alert-warning" role="alert">
                        <strong>Atenção!</strong> Nenhum fornecedor ou sócio associado encontrado. Selecione um fornecedor ou sócio no combobox abaixo para criar a cobrança.
                    </div>
                    <input type="hidden" id="transacaoData" th:value="${#temporals.format(transacao.data, 'yyyy-MM-dd')}" />
                    <input type="hidden" id="transacaoId" th:value="${transacao.id}" />
                    <div class="mb-3">
                        <label for="contaFinanceira" class="form-label">Conta Financeira para Quitação:</label>
                        <select class="form-control" id="contaFinanceira" name="contaFinanceiraId" required>
                            <option value="">Selecione uma Conta Financeira</option>
                            <!-- Options will be populated by JavaScript or Thymeleaf -->
                            <option th:each="conta : ${contasFinanceiras}" th:value="${conta.id}"
                                th:text="${conta.nome}"></option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <p>Soma dos valores selecionados: <span id="totalSelecionado">R$ 0,00</span></p>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th></th> <!-- Checkbox column -->
                                    <th>ID</th>
                                    <th>Rubrica</th>
                                    <th>Valor</th>
                                    <th>Data Vencimento</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="cobranca : ${cobrancasAssociadas}"
                                    th:if="${(cobranca.tipoCobranca != null and (cobranca.tipoCobranca.name() == 'OUTRAS_RUBRICAS' or cobranca.tipoCobranca.name() == 'AVULSA')) and (cobranca.status != null and cobranca.status.name() == 'ABERTA')}">
                                    <td><input type="checkbox" class="cobranca-checkbox" th:value="${cobranca.id}"
                                            th:data-valor="${cobranca.valor}" /></td>
                                    <td th:text="${cobranca.id}"></td>
                                    <td th:text="${cobranca.rubrica?.nome}"></td>
                                    <td
                                        th:text="${cobranca.valor != null ? 'R$ ' + #numbers.formatDecimal(cobranca.valor, 0, 'POINT', 2, 'POINT') : 'Não definido'}">
                                    </td>
                                    <td th:text="${cobranca.dataVencimento != null ? #temporals.format(cobranca.dataVencimento, 'dd/MM/yyyy') : 'Não definida'}"></td>
                                    <td th:text="${cobranca.status != null ? cobranca.status.descricao : 'Não definido'}"></td>
                                    <td>
                                        <button type="button" class="btn btn-danger btn-sm"
                                            th:onclick="'confirmDeleteCobranca(' + ${cobranca.id} + ')'">Excluir</button>
                                    </td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(cobrancasAssociadas)}">
                                    <td colspan="7">Nenhuma cobrança associada encontrada para esta transação.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button type="submit" class="btn btn-primary" id="btnQuitarSelecionadas">Quitar Cobranças
                        Selecionadas</button>
                </form>
            </div>
        </div>

        <div class="card mb-4" th:if="${transacao.lancado != null and transacao.lancado.name() != 'LANCADO'}">
            <div class="card-header">
                Criar Nova Cobrança (Despesa)
            </div>
            <div class="card-body">
                <form id="novaCobrancaForm">
                    <div th:if="${transacao.fornecedorId == null and (transacao.tipoRelacionamento == null or transacao.tipoRelacionamento.name() == 'NAO_ENCONTRADO')}" class="alert alert-warning" role="alert">
                        <strong>Atenção!</strong> Nenhum fornecedor ou sócio associado encontrado. Selecione um fornecedor ou sócio no combobox abaixo para criar a cobrança.
                    </div>
                    <input type="hidden" id="transacaoIdNovaCobranca" th:value="${transacao.id}" />
                    <input type="hidden" id="fornecedorIdNovaCobranca" th:value="${transacao.fornecedorId}" th:if="${transacao.fornecedorId != null}" />
                    <input type="hidden" id="fornecedorIdNovaCobranca" value="" th:if="${transacao.fornecedorId == null}" />
                    <input type="hidden" id="tipoRelacionamento" th:value="${transacao.tipoRelacionamento}" />
                    <div class="mb-3">
                        <label for="fornecedorOuSocio" class="form-label">Fornecedor ou Sócio:</label>
                        <select class="form-control" id="fornecedorOuSocio" required>
                            <option value="">Selecione um Fornecedor ou Sócio</option>
                            <optgroup label="Fornecedores">
                                <option th:each="fornecedor : ${fornecedores}" 
                                        th:value="${'FORNECEDOR_' + fornecedor.id}" 
                                        th:text="${fornecedor.nome}"
                                        th:selected="${transacao.tipoRelacionamento != null and transacao.tipoRelacionamento.name() == 'FORNECEDOR' and transacao.relacionadoId != null and transacao.relacionadoId == fornecedor.id}"></option>
                            </optgroup>
                            <optgroup label="Sócios">
                                <option th:each="socio : ${socios}" 
                                        th:value="${'SOCIO_' + socio.id}" 
                                        th:text="${socio.nome + ' - ' + socio.cpf}"
                                        th:selected="${transacao.tipoRelacionamento != null and transacao.tipoRelacionamento.name() == 'SOCIO' and transacao.relacionadoId != null and transacao.relacionadoId == socio.id}"></option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="descricaoNovaCobranca" class="form-label">Descrição:</label>
                        <input type="text" class="form-control" id="descricaoNovaCobranca"
                            th:value="${transacao.descricao + ' - ' + transacao.fornecedorOuSocio}" required>
                    </div>
                    <div class="mb-3">
                        <label for="valorNovaCobranca" class="form-label">Valor:</label>
                        <input type="text" class="form-control" id="valorNovaCobranca" th:value="${transacao.valor}"
                            required>
                    </div>
                    <div class="mb-3">
                        <label for="dataVencimentoNovaCobranca" class="form-label">Data de Vencimento:</label>
                        <input type="text" class="form-control" id="dataVencimentoNovaCobranca"
                            th:value="${#temporals.format(transacao.data, 'dd/MM/yyyy')}" required>
                    </div>
                    <div class="mb-3">
                        <label for="rubricaNovaCobranca" class="form-label">Rubrica (Despesa):</label>
                        <div class="input-group">
                            <select class="form-control" id="rubricaNovaCobranca" required>
                                <option value="">Selecione uma Rubrica</option>
                                <option th:each="rubrica : ${rubricasDespesa}" th:value="${rubrica.id}"
                                    th:text="${rubrica.nome}"></option>
                            </select>
                            <button type="button" class="btn btn-outline-primary" id="btnCriarRubrica" title="Criar nova rubrica">
                                <i class="fas fa-plus"></i> Criar Rubrica
                            </button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-success" onclick="confirmEnviarFormulario()">Criar Cobrança</button>
                </form>
            </div>
        </div>

        <!-- Modal para criação de rubricas -->
        <div class="modal fade" id="modalCriarRubrica" tabindex="-1" aria-labelledby="modalCriarRubricaLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalCriarRubricaLabel">Criar Nova Rubrica</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="formCriarRubrica">
                            <div class="mb-3">
                                <label for="nomeRubrica" class="form-label">Nome da Rubrica</label>
                                <input type="text" class="form-control" id="nomeRubrica" required>
                            </div>
                            <div class="mb-3">
                                <label for="tipoRubrica" class="form-label">Tipo</label>
                                <select class="form-control" id="tipoRubrica" required>
                                    <option value="">Selecione...</option>
                                    <option value="RECEITA">Receita</option>
                                    <option value="DESPESA">Despesa</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="centroCustoRubrica" class="form-label">Centro de Custo</label>
                                <select class="form-control" id="centroCustoRubrica" required>
                                    <option value="">Selecione...</option>
                                    <!-- As opções serão carregadas dinamicamente via JavaScript -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="valorPadraoRubrica" class="form-label">Valor Padrão</label>
                                <input type="text" class="form-control" id="valorPadraoRubrica" required>
                                <input type="hidden" id="valorPadraoRubricaHidden">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="btnSalvarRubrica">Salvar Rubrica</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

<th:block th:fragment="pageScripts">
    <script th:inline="javascript">
        /*<![CDATA[*/
        function enviarFormulario() {
            const postUrl = /*[[@{/cobrancas/criarNovaDespesa}]]*/ '/cobrancas/criarNovaDespesa';

            const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            // Validação dos campos obrigatórios
            const transacaoId = document.getElementById('transacaoIdNovaCobranca').value;
            if (!transacaoId) {
                Swal.fire({
                    title: "Erro!",
                    text: "ID da transação não encontrado.",
                    icon: "error"
                });
                return;
            }

            // Obter o fornecedor ou sócio selecionado
            const fornecedorOuSocioSelect = document.getElementById('fornecedorOuSocio');
            const fornecedorOuSocioValue = fornecedorOuSocioSelect.value;
            
            // Verificar se temos um fornecedor ID já definido na transação
            let fornecedorId = document.getElementById('fornecedorIdNovaCobranca').value;
            let tipoRelacionamento = 'FORNECEDOR'; // Padrão para fornecedor
            
            // Se não temos um fornecedor ID definido, tentar obter do select
            if (!fornecedorId || fornecedorId === '') {
                if (!fornecedorOuSocioValue || fornecedorOuSocioValue === '') {
                    Swal.fire({
                        title: "Erro!",
                        text: "Por favor, selecione um fornecedor ou sócio.",
                        icon: "error"
                    });
                    return;
                }

                // Extrair o tipo e ID
                if (fornecedorOuSocioValue.startsWith('FORNECEDOR_')) {
                    fornecedorId = fornecedorOuSocioValue.substring(11); // Remove 'FORNECEDOR_' prefix
                    tipoRelacionamento = 'FORNECEDOR';
                } else if (fornecedorOuSocioValue.startsWith('SOCIO_')) {
                    fornecedorId = fornecedorOuSocioValue.substring(6); // Remove 'SOCIO_' prefix
                    tipoRelacionamento = 'SOCIO';
                }
            } else {
                // Se já temos o fornecedor ID da transação, usar esse
                tipoRelacionamento = document.getElementById('tipoRelacionamento').value || 'FORNECEDOR';
            }

            const rubricaId = document.getElementById('rubricaNovaCobranca').value;
            if (!rubricaId) {
                Swal.fire({
                    title: "Erro!",
                    text: "Por favor, selecione uma rubrica.",
                    icon: "error"
                });
                return;
            }

            const descricao = document.getElementById('descricaoNovaCobranca').value;
            if (!descricao || descricao.trim() === '') {
                Swal.fire({
                    title: "Erro!",
                    text: "Por favor, insira uma descrição.",
                    icon: "error"
                });
                return;
            }

            const valorInput = document.getElementById('valorNovaCobranca').value;
            const valor = parseFloat(valorInput.replace(',', '.'));
            if (isNaN(valor) || valor <= 0) {
                Swal.fire({
                    title: "Erro!",
                    text: "Por favor, insira um valor válido maior que zero.",
                    icon: "error"
                });
                return;
            }

            const rawDate = document.getElementById('dataVencimentoNovaCobranca').value;
            const dateParts = rawDate.split('/');
            
            // Verifica se a data é válida
            if (dateParts.length !== 3) {
                Swal.fire({
                    title: "Erro!",
                    text: "Por favor, insira uma data de vencimento válida no formato dd/mm/aaaa.",
                    icon: "error"
                });
                return;
            }
            
            const formattedDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;

            const payload = {
                transacaoId: transacaoId,
                fornecedorId: fornecedorId,
                tipoRelacionamento: tipoRelacionamento,
                descricao: descricao,
                valor: valor,
                dataVencimento: formattedDate,
                rubricaId: rubricaId,
            };

            fetch(postUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [header]: token
                },
                body: JSON.stringify(payload)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.message && data.message.includes('sucesso')) {
                        window.location.reload();
                    } else {
                        Swal.fire({
                            title: "Erro!",
                            text: data.message || "Erro ao criar a cobrança.",
                            icon: "error"
                        });
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    Swal.fire({
                        title: "Erro!",
                        text: "Ocorreu um erro ao criar a cobrança.",
                        icon: "error"
                    });
                });
        }

        // JavaScript para calcular a soma dos valores das cobranças selecionadas
        document.addEventListener('DOMContentLoaded', function () {
            const checkboxes = document.querySelectorAll('.cobranca-checkbox');
            const totalSpan = document.getElementById('totalSelecionado');
            const quitarButton = document.getElementById('btnQuitarSelecionadas');
            const transacaoValor = parseFloat(/*[[${transacao.valor}]]*/ '0');

            function calcularTotal() {
                let totalSelecionado = 0;
                let selecionados = 0;
                checkboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        totalSelecionado += parseFloat(checkbox.dataset.valor);
                        selecionados++;
                    }
                });
                totalSpan.textContent = `R$ ${totalSelecionado.toFixed(2).replace('.', ',')}`;

                // Adiciona validação visual
                if (Math.abs(totalSelecionado - transacaoValor) < 0.01) {
                    totalSpan.style.color = 'green';
                } else {
                    totalSpan.style.color = 'red';
                }

                // Desabilitar botão se nenhuma cobrança estiver selecionada
                if (quitarButton) {
                    quitarButton.disabled = selecionados === 0;
                }
            }

            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', calcularTotal);
            });

            calcularTotal(); // Calcula o total inicial ao carregar a página

            // Lidar com a submissão do formulário de quitação em lote
            const quitarCobrancasForm = document.getElementById('quitarCobrancasForm');
            quitarCobrancasForm.addEventListener('submit', function (event) {
                event.preventDefault(); // Previne a submissão padrão do formulário

                // Verificar se o fornecedor ID está presente
                const transacaoId = document.getElementById('transacaoId').value;
                if (!transacaoId) {
                    Swal.fire({
                        title: "Erro!",
                        text: "ID da transação não encontrado.",
                        icon: "error"
                    });
                    return;
                }

                const contaFinanceiraId = document.getElementById('contaFinanceira').value;
                const selectedCobrancaIds = Array.from(document.querySelectorAll('.cobranca-checkbox:checked'))
                    .map(cb => cb.value);

                if (selectedCobrancaIds.length === 0) {
                    Swal.fire({
                        title: "Atenção!",
                        text: "Por favor, selecione pelo menos uma cobrança para quitar.",
                        icon: "warning"
                    });
                    return;
                }

                if (!contaFinanceiraId) {
                    Swal.fire({
                        title: "Atenção!",
                        text: "Por favor, selecione uma conta financeira.",
                        icon: "warning"
                    });
                    return;
                }

                const payload = {
                    transacaoId: transacaoId,
                    contaFinanceiraId: contaFinanceiraId,
                    cobrancaIds: selectedCobrancaIds,
                    dataPagamento: document.getElementById('transacaoData').value
                };

                const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                fetch('/cobrancas/quitarEmLote', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [header]: token
                    },
                    body: JSON.stringify(payload)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message && data.message.includes('sucesso')) {
                            window.location.reload();
                        } else {
                            Swal.fire({
                                title: "Erro!",
                                text: data.message || "Erro ao quitar as cobranças.",
                                icon: "error"
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Erro:', error);
                        Swal.fire({
                            title: "Erro!",
                            text: "Ocorreu um erro ao quitar as cobranças.",
                            icon: "error"
                        });
                    });
            });
        });

        function confirmEnviarFormulario() {
            Swal.fire({
                title: "Confirmar Criação?",
                text: "Deseja realmente criar esta nova cobrança?",
                icon: "question",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Sim, criar!",
                cancelButtonText: "Cancelar",
            }).then((result) => {
                if (result.isConfirmed) {
                    enviarFormulario();
                }
            });
        }

        function confirmDeleteCobranca(cobrancaId) {
            Swal.fire({
                title: "Você tem certeza?",
                text: "Esta ação não poderá ser revertida!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Sim, excluir!",
                cancelButtonText: "Cancelar",
            }).then((result) => {
                if (result.isConfirmed) {
                    deleteCobranca(cobrancaId);
                }
            });
        }

        function deleteCobranca(cobrancaId) {
            console.log('Excluindo cobrança com ID:', cobrancaId);
            const deleteUrl = '/cobrancas/' + cobrancaId;
            console.log('URL de exclusão:', deleteUrl);

            const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            fetch(deleteUrl, {
                method: 'DELETE',
                headers: {
                    [header]: token
                }
            })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        return response.json().then(error => {
                            throw new Error(error.message || 'Erro ao excluir a cobrança.');
                        });
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                });
        }

        // Funções para criação de rubricas
        function carregarCentrosCusto() {
            // Esta função carrega os centros de custo via AJAX
            const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            fetch('/cadastros/centros-de-custo/all', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    [header]: token
                }
            })
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('centroCustoRubrica');
                    select.innerHTML = '<option value="">Selecione...</option>';
                    data.forEach(centro => {
                        const option = document.createElement('option');
                        option.value = centro.id;
                        option.textContent = centro.nome;
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar centros de custo:', error);
                });
        }

        function abrirModalCriarRubrica() {
            // Carregar centros de custo antes de abrir o modal
            carregarCentrosCusto();
            // Abrir o modal
            const modal = new bootstrap.Modal(document.getElementById('modalCriarRubrica'));
            modal.show();
        }

        function salvarRubrica() {
            // Desmascarar o valor antes de enviar
            $('#formCriarRubrica').trigger('submit');

            const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            const payload = {
                nome: document.getElementById('nomeRubrica').value,
                tipo: document.getElementById('tipoRubrica').value,
                centroCustoId: parseInt(document.getElementById('centroCustoRubrica').value),
                valorPadrao: parseFloat(document.getElementById('valorPadraoRubricaHidden').value)
            };

            // Validar campos obrigatórios
            if (!payload.nome || !payload.tipo || !payload.centroCustoId || isNaN(payload.valorPadrao)) {
                Swal.fire({
                    title: "Erro!",
                    text: "Por favor, preencha todos os campos obrigatórios.",
                    icon: "error"
                });
                return;
            }

            fetch('/cadastros/rubricas/salvar-ajax', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [header]: token
                },
                body: JSON.stringify(payload)
            })
                .then(response => {
                    if (response.ok) {
                        // Fechar o modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('modalCriarRubrica'));
                        modal.hide();
                        // Mostrar mensagem de sucesso
                        Swal.fire({
                            title: "Sucesso!",
                            text: "Rubrica criada com sucesso!",
                            icon: "success"
                        }).then(() => {
                            // Recarregar a página para atualizar a lista de rubricas
                            window.location.reload();
                        });
                    } else {
                        return response.json().then(error => {
                            throw new Error(error.message || 'Erro ao criar a rubrica.');
                        });
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    Swal.fire({
                        title: "Erro!",
                        text: "Ocorreu um erro ao criar a rubrica: " + error.message,
                        icon: "error"
                    });
                });
        }

        // Adicionar event listeners
        document.addEventListener('DOMContentLoaded', function () {
            // Adicionar listener para o botão de criar rubrica
            document.getElementById('btnCriarRubrica').addEventListener('click', abrirModalCriarRubrica);
            
            // Adicionar listener para o botão de salvar rubrica
            document.getElementById('btnSalvarRubrica').addEventListener('click', salvarRubrica);
            
            // Inicializar o maskMoney no campo de valor da rubrica
            $('#valorPadraoRubrica').maskMoney({
                prefix: 'R$ ',
                thousands: '.',
                decimal: ',',
                allowEmpty: true
            });

            // Submissão do formulário para desmascarar o valor
            $('#formCriarRubrica').submit(function () {
                const valorNumerico = $('#valorPadraoRubrica').maskMoney('unmasked')[0];
                $('#valorPadraoRubricaHidden').val(valorNumerico);
            });
        });
        /*]]>*/
    </script>
</th:block>

</html>