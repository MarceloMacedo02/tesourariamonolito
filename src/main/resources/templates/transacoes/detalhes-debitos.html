<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    th:replace="~{layout(titulo='Detalhes da Transação de Débito', content=~{::content}, pageScripts=~{::pageScripts})}">

<head>
    <title>Detalhes da Transação de Débito</title>
</head>

<body>
    <div th:fragment="content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">Detalhes da Transação de Débito</h1>
            <div th:if="${success}" class="alert alert-success mt-3" role="alert">
                <span th:text="${success}"></span>
            </div>
            <div th:if="${error}" class="alert alert-danger mt-3" role="alert">
                <span th:text="${error}"></span>
            </div>
            <div>
                <a th:href="@{/transacoes/review}" class="btn btn-secondary">Voltar para Revisão de Transações</a>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                Informações da Transação
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-3">ID</dt>
                    <dd class="col-sm-9" th:text="${transacao.id}"></dd>

                    <dt class="col-sm-3">Data</dt>
                    <dd class="col-sm-9" th:text="${#temporals.format(transacao.data, 'dd/MM/yyyy')}"></dd>

                    <dt class="col-sm-3">Tipo</dt>
                    <dd class="col-sm-9" th:text="${transacao.tipo?.descricao}"></dd>

                    <dt class="col-sm-3">Valor</dt>
                    <dd class="col-sm-9"
                        th:text="${'R$ ' + #numbers.formatDecimal(transacao.valor, 0, 'POINT', 2, 'POINT')}"></dd>

                    <dt class="col-sm-3">Descrição</dt>
                    <dd class="col-sm-9" th:text="${transacao.descricao}"></dd>

                    <dt class="col-sm-3">Fornecedor/Sócio</dt>
                    <dd class="col-sm-9" th:text="${transacao.fornecedorOuSocio}"></dd>

                    <dt class="col-sm-3">Documento</dt>
                    <dd class="col-sm-9" th:text="${transacao.documento}"></dd>

                    <dt class="col-sm-3">Status de Lançamento</dt>
                    <dd class="col-sm-9" th:text="${transacao.lancado.descricao}"></dd>
                </dl>
            </div>
        </div>

        <div class="card mb-4" th:if="${transacao.lancado.name() != 'LANCADO'}">
            <div class="card-header">
                Cobranças Associadas
            </div>
            <div class="card-body">
                <form id="quitarCobrancasForm">
                    <input type="hidden" id="transacaoData" th:value="${#temporals.format(transacao.data, 'yyyy-MM-dd')}" />
                    <input type="hidden" id="transacaoId" th:value="${transacao.id}" />
                    <div class="mb-3">
                        <label for="contaFinanceira" class="form-label">Conta Financeira para Quitação:</label>
                        <select class="form-control" id="contaFinanceira" name="contaFinanceiraId" required>
                            <option value="">Selecione uma Conta Financeira</option>
                            <!-- Options will be populated by JavaScript or Thymeleaf -->
                            <option th:each="conta : ${contasFinanceiras}" th:value="${conta.id}"
                                th:text="${conta.nome}"></option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <p>Soma dos valores selecionados: <span id="totalSelecionado">R$ 0,00</span></p>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th></th> <!-- Checkbox column -->
                                    <th>ID</th>
                                    <th>Rubrica</th>
                                    <th>Valor</th>
                                    <th>Data Vencimento</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="cobranca : ${cobrancasAssociadas}"
                                    th:if="${(cobranca.tipoCobranca.name() == 'OUTRAS_RUBRICAS' or cobranca.tipoCobranca.name() == 'AVULSA') and cobranca.status.name() == 'ABERTA'}">
                                    <td><input type="checkbox" class="cobranca-checkbox" th:value="${cobranca.id}"
                                            th:data-valor="${cobranca.valor}" /></td>
                                    <td th:text="${cobranca.id}"></td>
                                    <td th:text="${cobranca.rubrica?.nome}"></td>
                                    <td
                                        th:text="${'R$ ' + #numbers.formatDecimal(cobranca.valor, 0, 'POINT', 2, 'POINT')}">
                                    </td>
                                    <td th:text="${#temporals.format(cobranca.dataVencimento, 'dd/MM/yyyy')}"></td>
                                    <td th:text="${cobranca.status?.descricao}"></td>
                                    <td>
                                        <button type="button" class="btn btn-danger btn-sm"
                                            th:onclick="'confirmDeleteCobranca(' + ${cobranca.id} + ')'">Excluir</button>
                                    </td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(cobrancasAssociadas)}">
                                    <td colspan="7">Nenhuma cobrança associada encontrada para esta transação.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button type="submit" class="btn btn-primary" id="btnQuitarSelecionadas">Quitar Cobranças
                        Selecionadas</button>
                </form>
            </div>
        </div>

        <div class="card mb-4" th:if="${transacao.lancado.name() != 'LANCADO'}">
            <div class="card-header">
                Criar Nova Cobrança (Despesa)
            </div>
            <div class="card-body">
                <form id="novaCobrancaForm">
                    <input type="hidden" id="transacaoIdNovaCobranca" th:value="${transacao.id}" />
                    <input type="hidden" id="fornecedorIdNovaCobranca" th:value="${transacao.fornecedorId}" />
                    <div class="mb-3">
                        <label for="descricaoNovaCobranca" class="form-label">Descrição:</label>
                        <input type="text" class="form-control" id="descricaoNovaCobranca"
                            th:value="${transacao.descricao + ' - ' + transacao.fornecedorOuSocio}" required>
                    </div>
                    <div class="mb-3">
                        <label for="valorNovaCobranca" class="form-label">Valor:</label>
                        <input type="text" class="form-control" id="valorNovaCobranca" th:value="${transacao.valor}"
                            required>
                    </div>
                    <div class="mb-3">
                        <label for="dataVencimentoNovaCobranca" class="form-label">Data de Vencimento:</label>
                        <input type="text" class="form-control" id="dataVencimentoNovaCobranca"
                            th:value="${#temporals.format(transacao.data, 'dd/MM/yyyy')}" required>
                    </div>
                    <div class="mb-3">
                        <label for="rubricaNovaCobranca" class="form-label">Rubrica (Despesa):</label>
                        <select class="form-control" id="rubricaNovaCobranca" required>
                            <option value="">Selecione uma Rubrica</option>
                            <option th:each="rubrica : ${rubricasDespesa}" th:value="${rubrica.id}"
                                th:text="${rubrica.nome}"></option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-success" onclick="confirmEnviarFormulario()">Criar Cobrança</button>
                </form>
            </div>
        </div>
    </div>
</body>

<th:block th:fragment="pageScripts">
    <script th:inline="javascript">
        /*<![CDATA[*/
        function enviarFormulario() {
            const postUrl = /*[[@{/cobrancas/criarNovaDespesa}]]*/ '/cobrancas/criarNovaDespesa';

            const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            // Validação dos campos obrigatórios
            const transacaoId = document.getElementById('transacaoIdNovaCobranca').value;
            if (!transacaoId) {
                Swal.fire({
                    title: "Erro!",
                    text: "ID da transação não encontrado.",
                    icon: "error"
                });
                return;
            }

            const fornecedorId = document.getElementById('fornecedorIdNovaCobranca').value;
            if (!fornecedorId) {
                Swal.fire({
                    title: "Erro!",
                    text: "ID do fornecedor não encontrado.",
                    icon: "error"
                });
                return;
            }

            const rubricaId = document.getElementById('rubricaNovaCobranca').value;
            if (!rubricaId) {
                Swal.fire({
                    title: "Erro!",
                    text: "Por favor, selecione uma rubrica.",
                    icon: "error"
                });
                return;
            }

            const descricao = document.getElementById('descricaoNovaCobranca').value;
            if (!descricao || descricao.trim() === '') {
                Swal.fire({
                    title: "Erro!",
                    text: "Por favor, insira uma descrição.",
                    icon: "error"
                });
                return;
            }

            const valorInput = document.getElementById('valorNovaCobranca').value;
            const valor = parseFloat(valorInput.replace(',', '.'));
            if (isNaN(valor) || valor <= 0) {
                Swal.fire({
                    title: "Erro!",
                    text: "Por favor, insira um valor válido maior que zero.",
                    icon: "error"
                });
                return;
            }

            const rawDate = document.getElementById('dataVencimentoNovaCobranca').value;
            const dateParts = rawDate.split('/');
            
            // Verifica se a data é válida
            if (dateParts.length !== 3) {
                Swal.fire({
                    title: "Erro!",
                    text: "Por favor, insira uma data de vencimento válida no formato dd/mm/aaaa.",
                    icon: "error"
                });
                return;
            }
            
            const formattedDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;

            const payload = {
                transacaoId: transacaoId,
                fornecedorId: fornecedorId,
                descricao: descricao,
                valor: valor,
                dataVencimento: formattedDate,
                rubricaId: rubricaId,
            };

            fetch(postUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [header]: token
                },
                body: JSON.stringify(payload)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.message && data.message.includes('sucesso')) {
                        window.location.reload();
                    } else {
                        Swal.fire({
                            title: "Erro!",
                            text: data.message || "Erro ao criar a cobrança.",
                            icon: "error"
                        });
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    Swal.fire({
                        title: "Erro!",
                        text: "Ocorreu um erro ao criar a cobrança.",
                        icon: "error"
                    });
                });
        }

        // JavaScript para calcular a soma dos valores das cobranças selecionadas
        document.addEventListener('DOMContentLoaded', function () {
            const checkboxes = document.querySelectorAll('.cobranca-checkbox');
            const totalSpan = document.getElementById('totalSelecionado');
            const transacaoValor = parseFloat(/*[[${transacao.valor}]]*/ '0');

            function calcularTotal() {
                let totalSelecionado = 0;
                checkboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        totalSelecionado += parseFloat(checkbox.dataset.valor);
                    }
                });
                totalSpan.textContent = `R$ ${totalSelecionado.toFixed(2).replace('.', ',')}`;

                // Adiciona validação visual
                if (Math.abs(totalSelecionado - transacaoValor) < 0.01) {
                    totalSpan.style.color = 'green';
                } else {
                    totalSpan.style.color = 'red';
                }
            }

            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', calcularTotal);
            });

            calcularTotal(); // Calcula o total inicial ao carregar a página

            // Lidar com a submissão do formulário de quitação em lote
            const quitarCobrancasForm = document.getElementById('quitarCobrancasForm');
            quitarCobrancasForm.addEventListener('submit', function (event) {
                event.preventDefault(); // Previne a submissão padrão do formulário

                const transacaoId = document.getElementById('transacaoId').value;
                const contaFinanceiraId = document.getElementById('contaFinanceira').value;
                const selectedCobrancaIds = Array.from(document.querySelectorAll('.cobranca-checkbox:checked'))
                    .map(cb => cb.value);

                if (selectedCobrancaIds.length === 0) {
                    return;
                }

                if (!contaFinanceiraId) {
                    return;
                }

                const payload = {
                    transacaoId: transacaoId,
                    contaFinanceiraId: contaFinanceiraId,
                    cobrancaIds: selectedCobrancaIds,
                    dataPagamento: document.getElementById('transacaoData').value
                };

                const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                fetch('/cobrancas/quitarEmLote', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [header]: token
                    },
                    body: JSON.stringify(payload)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message && data.message.includes('sucesso')) {
                            window.location.reload();
                        } else {
                            Swal.fire({
                                title: "Erro!",
                                text: data.message || "Erro ao quitar as cobranças.",
                                icon: "error"
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Erro:', error);
                        Swal.fire({
                            title: "Erro!",
                            text: "Ocorreu um erro ao quitar as cobranças.",
                            icon: "error"
                        });
                    });
            });
        });

        function confirmEnviarFormulario() {
            Swal.fire({
                title: "Confirmar Criação?",
                text: "Deseja realmente criar esta nova cobrança?",
                icon: "question",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Sim, criar!",
                cancelButtonText: "Cancelar",
            }).then((result) => {
                if (result.isConfirmed) {
                    enviarFormulario();
                }
            });
        }

        function confirmDeleteCobranca(cobrancaId) {
            Swal.fire({
                title: "Você tem certeza?",
                text: "Esta ação não poderá ser revertida!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Sim, excluir!",
                cancelButtonText: "Cancelar",
            }).then((result) => {
                if (result.isConfirmed) {
                    deleteCobranca(cobrancaId);
                }
            });
        }

        function deleteCobranca(cobrancaId) {
            console.log('Excluindo cobrança com ID:', cobrancaId);
            const deleteUrl = '/cobrancas/' + cobrancaId;
            console.log('URL de exclusão:', deleteUrl);

            const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            fetch(deleteUrl, {
                method: 'DELETE',
                headers: {
                    [header]: token
                }
            })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        return response.json().then(error => {
                            throw new Error(error.message || 'Erro ao excluir a cobrança.');
                        });
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                });
        }
        /*]]>*/
    </script>
</th:block>

</html>