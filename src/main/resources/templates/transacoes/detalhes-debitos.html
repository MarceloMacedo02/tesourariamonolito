<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    th:replace="~{layout(titulo='Detalhes da Transação de Débito', content=~{::content}, pageScripts=~{::pageScripts})}">

<head>
    <title>Detalhes da Transação de Débito</title>
</head>

<body>
    <div th:fragment="content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">Detalhes da Transação de Débito</h1>
            <div>
                <a th:href="@{/transacoes/review}" class="btn btn-secondary">Voltar para Revisão de Transações</a>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                Informações da Transação
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-3">ID</dt>
                    <dd class="col-sm-9" th:text="${transacao.id}"></dd>

                    <dt class="col-sm-3">Data</dt>
                    <dd class="col-sm-9" th:text="${#temporals.format(transacao.data, 'dd/MM/yyyy')}"></dd>

                    <dt class="col-sm-3">Tipo</dt>
                    <dd class="col-sm-9" th:text="${transacao.tipo?.descricao}"></dd>

                    <dt class="col-sm-3">Valor</dt>
                    <dd class="col-sm-9"
                        th:text="${'R$ ' + #numbers.formatDecimal(transacao.valor, 0, 'POINT', 2, 'POINT')}"></dd>

                    <dt class="col-sm-3">Descrição</dt>
                    <dd class="col-sm-9" th:text="${transacao.descricao}"></dd>

                    <dt class="col-sm-3">Fornecedor/Sócio</dt>
                    <dd class="col-sm-9" th:text="${transacao.fornecedorOuSocio}"></dd>

                    <dt class="col-sm-3">Documento</dt>
                    <dd class="col-sm-9" th:text="${transacao.documento}"></dd>

                    <dt class="col-sm-3">Status de Lançamento</dt>
                    <dd class="col-sm-9" th:text="${transacao.lancado.descricao}"></dd>
                </dl>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                Cobranças Associadas
            </div>
            <div class="card-body">
                <form id="quitarCobrancasForm">
                    <input type="hidden" id="transacaoId" th:value="${transacao.id}" />
                    <div class="mb-3">
                        <label for="contaFinanceira" class="form-label">Conta Financeira para Quitação:</label>
                        <select class="form-control" id="contaFinanceira" name="contaFinanceiraId" required>
                            <option value="">Selecione uma Conta Financeira</option>
                            <!-- Options will be populated by JavaScript or Thymeleaf -->
                            <option th:each="conta : ${contasFinanceiras}" th:value="${conta.id}"
                                th:text="${conta.nome}"></option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <p>Soma dos valores selecionados: <span id="totalSelecionado">R$ 0,00</span></p>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th></th> <!-- Checkbox column -->
                                    <th>ID</th>
                                    <th>Rubrica</th>
                                    <th>Valor</th>
                                    <th>Data Vencimento</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="cobranca : ${cobrancasAssociadas}"
                                    th:if="${(cobranca.tipoCobranca.name() == 'OUTRAS_RUBRICAS' or cobranca.tipoCobranca.name() == 'AVULSA') and cobranca.status.name() == 'ABERTA'}">
                                    <td><input type="checkbox" class="cobranca-checkbox" th:value="${cobranca.id}"
                                            th:data-valor="${cobranca.valor}" /></td>
                                    <td th:text="${cobranca.id}"></td>
                                    <td th:text="${cobranca.rubrica?.nome}"></td>
                                    <td
                                        th:text="${'R$ ' + #numbers.formatDecimal(cobranca.valor, 0, 'POINT', 2, 'POINT')}">
                                    </td>
                                    <td th:text="${#temporals.format(cobranca.dataVencimento, 'dd/MM/yyyy')}"></td>
                                    <td th:text="${cobranca.status?.descricao}"></td>
                                    <td>
                                        <!-- Actions for individual cobranca if needed -->
                                    </td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(cobrancasAssociadas)}">
                                    <td colspan="7">Nenhuma cobrança associada encontrada para esta transação.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button type="submit" class="btn btn-primary" id="btnQuitarSelecionadas">Quitar Cobranças
                        Selecionadas</button>
                </form>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                Criar Nova Cobrança (Despesa)
            </div>
            <div class="card-body">
                <form id="novaCobrancaForm">
                    <input type="hidden" id="transacaoIdNovaCobranca" th:value="${transacao.id}" />
                    <input type="hidden" id="fornecedorIdNovaCobranca" th:value="${transacao.fornecedorId}" />
                    <div class="mb-3">
                        <label for="descricaoNovaCobranca" class="form-label">Descrição:</label>
                        <input type="text" class="form-control" id="descricaoNovaCobranca"
                            th:value="${transacao.descricao + ' - ' + transacao.fornecedorOuSocio}" required>
                    </div>
                    <div class="mb-3">
                        <label for="valorNovaCobranca" class="form-label">Valor:</label>
                        <input type="text" class="form-control" id="valorNovaCobranca" th:value="${transacao.valor}"
                            required>
                    </div>
                    <div class="mb-3">
                        <label for="dataVencimentoNovaCobranca" class="form-label">Data de Vencimento:</label>
                        <input type="text" class="form-control" id="dataVencimentoNovaCobranca"
                            th:value="${#temporals.format(transacao.data, 'dd/MM/yyyy')}" required>
                    </div>
                    <div class="mb-3">
                        <label for="rubricaNovaCobranca" class="form-label">Rubrica (Despesa):</label>
                        <select class="form-control" id="rubricaNovaCobranca" required>
                            <option value="">Selecione uma Rubrica</option>
                            <option th:each="rubrica : ${rubricasDespesa}" th:value="${rubrica.id}"
                                th:text="${rubrica.nome}"></option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-success" onclick="enviarFormulario()">Criar Cobrança</button>
                </form>
            </div>
        </div>
    </div>
</body>

<th:block th:fragment="pageScripts">
    <script th:inline="javascript">
        /*<![CDATA[*/
        function enviarFormulario() {
            const postUrl = /*[[@{/cobrancas/criarNovaDespesa}]]*/ '/cobrancas/criarNovaDespesa';

            const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            const rawDate = document.getElementById('dataVencimentoNovaCobranca').value;
            const dateParts = rawDate.split('/');
            const formattedDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;

            const payload = {
                transacaoId: document.getElementById('transacaoIdNovaCobranca').value,
                fornecedorId: document.getElementById('fornecedorIdNovaCobranca').value,
                descricao: document.getElementById('descricaoNovaCobranca').value,
                valor: parseFloat(document.getElementById('valorNovaCobranca').value),
                dataVencimento: formattedDate,
                rubricaId: document.getElementById('rubricaNovaCobranca').value,
            };

            fetch(postUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [header]: token
                },
                body: JSON.stringify(payload)
            })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    if (data.message.includes('sucesso')) {
                        window.location.reload();
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Ocorreu um erro ao criar a cobrança.');
                });
        }
        /*]]>*/
    </script>
</th:block>

</html>